#cloud-config

# Cloud-init –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ Telegram Channel Finder Bot
# –≠—Ç–æ—Ç —Ñ–∞–π–ª –Ω—É–∂–Ω–æ –≤—Å—Ç–∞–≤–∏—Ç—å –≤ –ø–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è Timeweb Cloud

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–∫–µ—Ç–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
package_update: true
package_upgrade: false

# –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–∞–∫–µ—Ç–æ–≤
packages:
  - git
  - python3
  - python3-pip
  - python3-venv
  - postgresql-client
  - curl
  - htop
  - nano

# –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
users:
  - name: botuser
    groups: sudo
    shell: /bin/bash
    sudo: ['ALL=(ALL) NOPASSWD:ALL']

# –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–µ
runcmd:
  # –ü–µ—Ä–µ—Ö–æ–¥ –≤ —Ä–∞–±–æ—á—É—é –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é
  - cd /app
  
  # –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –ø—Ä–æ–µ–∫—Ç–∞
  - |
    if [ ! -f "/app/main.py" ]; then
      echo "–ü—Ä–æ–µ–∫—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ /app, –∫–ª–æ–Ω–∏—Ä—É–µ–º –∏–∑ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏—è..."
      git clone https://github.com/InfoBlog360/telegram-channel-finder-bot.git /tmp/bot
      cp -r /tmp/bot/* /app/
      rm -rf /tmp/bot
    fi
  
  # –°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è –µ—Å–ª–∏ –µ–≥–æ –Ω–µ—Ç
  - |
    if [ ! -d "/app/.venv" ]; then
      echo "–°–æ–∑–¥–∞–Ω–∏–µ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –æ–∫—Ä—É–∂–µ–Ω–∏—è..."
      cd /app
      python3 -m venv .venv
      source .venv/bin/activate
      pip install --upgrade pip
      pip install -r requirements.txt
    fi
  
  # –°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–æ–≤
  - |
    echo "–°–æ–∑–¥–∞–Ω–∏–µ systemd —Å–µ—Ä–≤–∏—Å–æ–≤..."
    
    # Telegram Bot Service
    cat > /etc/systemd/system/telegram-bot.service << 'EOF'
    [Unit]
    Description=Telegram Channel Finder Bot
    After=network.target postgresql.service
    Wants=postgresql.service
    StartLimitIntervalSec=0

    [Service]
    Type=simple
    Restart=always
    RestartSec=10
    User=root
    WorkingDirectory=/app
    Environment=PATH=/app/.venv/bin
    ExecStart=/app/.venv/bin/python main.py
    StandardOutput=journal
    StandardError=journal
    SyslogIdentifier=telegram-bot

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    NoNewPrivileges=true
    PrivateTmp=true

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
    MemoryMax=512M
    CPUQuota=50%

    [Install]
    WantedBy=multi-user.target
    EOF
    
    # Admin Panel Service
    cat > /etc/systemd/system/admin-panel.service << 'EOF'
    [Unit]
    Description=Telegram Bot Admin Panel
    After=network.target postgresql.service
    Wants=postgresql.service
    StartLimitIntervalSec=0

    [Service]
    Type=simple
    Restart=always
    RestartSec=10
    User=root
    WorkingDirectory=/app
    Environment=PATH=/app/.venv/bin
    ExecStart=/app/.venv/bin/python run_admin.py
    StandardOutput=journal
    StandardError=journal
    SyslogIdentifier=admin-panel

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    NoNewPrivileges=true
    PrivateTmp=true

    # –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–µ—Å—É—Ä—Å–æ–≤
    MemoryMax=512M
    CPUQuota=50%

    [Install]
    WantedBy=multi-user.target
    EOF
  
  # –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∏ –∑–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
  - systemctl daemon-reload
  - systemctl enable telegram-bot.service
  - systemctl enable admin-panel.service
  
  # –û–∂–∏–¥–∞–Ω–∏–µ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ —Å–∏—Å—Ç–µ–º—ã
  - sleep 10
  
  # –ó–∞–ø—É—Å–∫ —Å–µ—Ä–≤–∏—Å–æ–≤
  - systemctl start telegram-bot.service
  - systemctl start admin-panel.service
  
  # –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  - |
    cat > /app/manage_services.sh << 'EOF'
    #!/bin/bash
    # –ë—ã—Å—Ç—Ä—ã–π —Å–∫—Ä–∏–ø—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–ª—É–∂–±–∞–º–∏
    case "${1:-status}" in
        "status")
            systemctl status telegram-bot.service admin-panel.service --no-pager
            ;;
        "restart")
            systemctl restart telegram-bot.service admin-panel.service
            echo "–°–ª—É–∂–±—ã –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω—ã"
            ;;
        "stop")
            systemctl stop telegram-bot.service admin-panel.service
            echo "–°–ª—É–∂–±—ã –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã"
            ;;
        "start")
            systemctl start telegram-bot.service admin-panel.service
            echo "–°–ª—É–∂–±—ã –∑–∞–ø—É—â–µ–Ω—ã"
            ;;
        "logs")
            journalctl -u telegram-bot.service -u admin-panel.service --no-pager -n 50
            ;;
        *)
            echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: $0 {status|start|stop|restart|logs}"
            ;;
    esac
    EOF
    chmod +x /app/manage_services.sh
  
  # –°–æ–∑–¥–∞–Ω–∏–µ –∞–ª–∏–∞—Å–æ–≤ –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
  - echo 'alias bot-status="systemctl status telegram-bot.service admin-panel.service"' >> /root/.bashrc
  - echo 'alias bot-restart="systemctl restart telegram-bot.service admin-panel.service"' >> /root/.bashrc
  - echo 'alias bot-logs="journalctl -u telegram-bot.service -u admin-panel.service -f"' >> /root/.bashrc
  - echo 'alias bot-manage="/app/manage_services.sh"' >> /root/.bashrc

# –§–∞–π–ª—ã –¥–ª—è –∑–∞–ø–∏—Å–∏
write_files:
  - path: /app/startup_check.sh
    permissions: '0755'
    content: |
      #!/bin/bash
      echo "üöÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–ª—É–∂–± Telegram –±–æ—Ç–∞..."
      sleep 30
      
      if ! systemctl is-active --quiet telegram-bot.service; then
        echo "‚ö†Ô∏è Telegram –±–æ—Ç –Ω–µ –∑–∞–ø—É—â–µ–Ω, –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞..."
        systemctl start telegram-bot.service
      fi
      
      if ! systemctl is-active --quiet admin-panel.service; then
        echo "‚ö†Ô∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –Ω–µ –∑–∞–ø—É—â–µ–Ω–∞, –ø–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞..."
        systemctl start admin-panel.service
      fi
      
      echo "‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞"

# –§–∏–Ω–∞–ª—å–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã
final_message: |
  üéâ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ Telegram Channel Finder Bot –∑–∞–≤–µ—Ä—à–µ–Ω–∞!
  
  –°–ª—É–∂–±—ã –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∏ –¥–æ–ª–∂–Ω—ã –∑–∞–ø—É—Å—Ç–∏—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.
  
  –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:
  - systemctl status telegram-bot.service
  - systemctl status admin-panel.service
  - /app/manage_services.sh status
  - journalctl -u telegram-bot.service -f
  
  –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ –∞–¥—Ä–µ—Å—É: http://YOUR_SERVER_IP:8080
