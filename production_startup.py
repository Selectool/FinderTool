#!/usr/bin/env python3
"""
Production Startup Script
ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¸ Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° production-ready ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹
Telegram Channel Finder Bot Ğ´Ğ»Ñ Dokploy
"""
import subprocess
import sys
import os
import time
import logging
import shutil
import asyncio
from pathlib import Path

# ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s [%(levelname)s] %(message)s',
    handlers=[
        logging.StreamHandler(sys.stdout),
        logging.FileHandler('/app/logs/production_startup.log', mode='a') if Path('/app/logs').exists() else logging.StreamHandler(sys.stdout)
    ]
)
logger = logging.getLogger(__name__)

class ProductionInstaller:
    """ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ñ‰Ğ¸Ğº production ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹"""

    def __init__(self):
        self.app_dir = Path("/app")
        self.venv_dir = self.app_dir / ".venv"
        self.logs_dir = self.app_dir / "logs"
        self.data_dir = self.app_dir / "data"
        self.python_executable = sys.executable

    def print_banner(self):
        """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ Ğ±Ğ°Ğ½Ğ½ĞµÑ€ Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°"""
        banner = """
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                              â•‘
â•‘           ğŸš€ TELEGRAM CHANNEL FINDER BOT ğŸš€                 â•‘
â•‘                                                              â•‘
â•‘              PRODUCTION AUTO-INSTALLER                       â•‘
â•‘                                                              â•‘
â•‘  ğŸ¯ Senior Developer Level Production-Ready System          â•‘
â•‘  ğŸ“¦ Automatic Installation & Configuration                  â•‘
â•‘  ğŸ“Š Supervisor Process Management                            â•‘
â•‘  ğŸ”„ Automatic Migrations & Data Sync                        â•‘
â•‘  ğŸ’¾ Data Persistence & Backup System                        â•‘
â•‘  ğŸ” Health Monitoring & Auto-Recovery                       â•‘
â•‘  ğŸŒ Web Admin Panel with Authentication                     â•‘
â•‘                                                              â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
        print(banner)

    def run_command(self, command, check=True, shell=True, cwd=None, timeout=300):
        """Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ Ñ Ğ»Ğ¾Ğ³Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸ĞµĞ¼"""
        try:
            logger.info(f"ğŸ”§ Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ÑĞµĞ¼: {command}")

            if shell and isinstance(command, str):
                result = subprocess.run(
                    command,
                    shell=True,
                    check=check,
                    capture_output=True,
                    text=True,
                    cwd=cwd or self.app_dir,
                    timeout=timeout
                )
            else:
                result = subprocess.run(
                    command,
                    check=check,
                    capture_output=True,
                    text=True,
                    cwd=cwd or self.app_dir,
                    timeout=timeout
                )

            if result.stdout:
                logger.info(f"âœ… Ğ’Ñ‹Ğ²Ğ¾Ğ´: {result.stdout.strip()}")
            if result.stderr and result.returncode == 0:
                logger.warning(f"âš ï¸ ĞŸÑ€ĞµĞ´ÑƒĞ¿Ñ€ĞµĞ¶Ğ´ĞµĞ½Ğ¸Ñ: {result.stderr.strip()}")

            return result

        except subprocess.CalledProcessError as e:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹: {e}")
            if e.stdout:
                logger.error(f"Stdout: {e.stdout}")
            if e.stderr:
                logger.error(f"Stderr: {e.stderr}")
            if check:
                raise
            return e
        except subprocess.TimeoutExpired as e:
            logger.error(f"â° ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ¿Ñ€ĞµĞ²Ñ‹ÑĞ¸Ğ»Ğ° Ğ²Ñ€ĞµĞ¼Ñ Ğ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ¸Ñ: {command}")
            if check:
                raise
            return e
        except Exception as e:
            logger.error(f"âŒ ĞĞµĞ¾Ğ¶Ğ¸Ğ´Ğ°Ğ½Ğ½Ğ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {e}")
            if check:
                raise
            return e

    def check_system_requirements(self):
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ"""
        logger.info("ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹...")

        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Python Ğ²ĞµÑ€ÑĞ¸Ñ
        python_version = sys.version_info
        if python_version < (3, 8):
            logger.error(f"âŒ Ğ¢Ñ€ĞµĞ±ÑƒĞµÑ‚ÑÑ Python 3.8+, Ğ½Ğ°Ğ¹Ğ´ĞµĞ½ {python_version.major}.{python_version.minor}")
            return False

        logger.info(f"âœ… Python {python_version.major}.{python_version.minor}.{python_version.micro}")

        # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ¾ÑÑ‚ÑŒ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´
        required_commands = ['pip', 'git']
        for cmd in required_commands:
            try:
                result = self.run_command(f"which {cmd}", check=False)
                if result.returncode == 0:
                    logger.info(f"âœ… {cmd}: {result.stdout.strip()}")
                else:
                    logger.warning(f"âš ï¸ {cmd} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½, Ğ¿Ğ¾Ğ¿Ñ‹Ñ‚Ğ°ĞµĞ¼ÑÑ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ")
            except:
                logger.warning(f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ {cmd}")

        return True

    def install_system_dependencies(self):
        """Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸"""
        logger.info("ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹...")

        try:
            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ ÑĞ¿Ğ¸ÑĞ¾Ğº Ğ¿Ğ°ĞºĞµÑ‚Ğ¾Ğ²
            self.run_command("apt-get update", check=False)

            # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ğ¿Ğ°ĞºĞµÑ‚Ñ‹
            packages = [
                "python3-pip",
                "python3-venv",
                "python3-dev",
                "build-essential",
                "libpq-dev",
                "git",
                "curl",
                "supervisor"
            ]

            for package in packages:
                logger.info(f"ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° {package}...")
                result = self.run_command(f"apt-get install -y {package}", check=False)
                if result.returncode == 0:
                    logger.info(f"âœ… {package} ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½")
                else:
                    logger.warning(f"âš ï¸ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ {package} Ñ‡ĞµÑ€ĞµĞ· apt")

            return True

        except Exception as e:
            logger.warning(f"âš ï¸ ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹: {e}")
            logger.info("ğŸ”„ ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ğ±ĞµĞ· ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹...")
            return True

    def create_directories(self):
        """Ğ¡Ğ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ½ĞµĞ¾Ğ±Ñ…Ğ¾Ğ´Ğ¸Ğ¼Ñ‹Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¸"""
        logger.info("ğŸ“ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹...")

        directories = [
            self.logs_dir,
            self.data_dir,
            self.data_dir / "backups",
            self.data_dir / "deploy_backups",
            self.data_dir / "health_reports",
            self.app_dir / "database" / "backups"
        ]

        for directory in directories:
            try:
                directory.mkdir(parents=True, exist_ok=True)
                logger.info(f"âœ… Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ° Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ: {directory}")
            except Exception as e:
                logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ {directory}: {e}")
                return False

        return True

    def setup_virtual_environment(self):
        """ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ"""
        logger.info("ğŸ ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ...")

        try:
            # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ ĞµÑĞ»Ğ¸ ĞµĞ³Ğ¾ Ğ½ĞµÑ‚
            if not self.venv_dir.exists():
                logger.info("ğŸ“¦ Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ...")
                self.run_command(f"{self.python_executable} -m venv {self.venv_dir}")
            else:
                logger.info("âœ… Ğ’Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ ÑƒĞ¶Ğµ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒĞµÑ‚")

            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ°ĞºÑ‚Ğ¸Ğ²Ğ°Ñ†Ğ¸Ñ
            venv_python = self.venv_dir / "bin" / "python"
            if not venv_python.exists():
                logger.error("âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ ÑĞ¾Ğ·Ğ´Ğ°Ñ‚ÑŒ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ")
                return False

            logger.info("âœ… Ğ’Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ğµ Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ¾")
            return True

        except Exception as e:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ: {e}")
            return False

    def install_python_dependencies(self):
        """Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ Python Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸"""
        logger.info("ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Python Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹...")

        try:
            venv_pip = self.venv_dir / "bin" / "pip"

            # ĞĞ±Ğ½Ğ¾Ğ²Ğ»ÑĞµĞ¼ pip
            logger.info("ğŸ”„ ĞĞ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ğµ pip...")
            self.run_command(f"{venv_pip} install --upgrade pip")

            # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸
            requirements_file = self.app_dir / "requirements.txt"
            if requirements_file.exists():
                logger.info("ğŸ“‹ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹ Ğ¸Ğ· requirements.txt...")
                self.run_command(f"{venv_pip} install -r {requirements_file}", timeout=600)
            else:
                logger.warning("âš ï¸ Ğ¤Ğ°Ğ¹Ğ» requirements.txt Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")

                # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ĞºÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸ Ğ²Ğ°Ğ¶Ğ½Ñ‹Ğµ Ğ¿Ğ°ĞºĞµÑ‚Ñ‹
                critical_packages = [
                    "aiogram==3.13.1",
                    "fastapi==0.104.1",
                    "uvicorn[standard]==0.24.0",
                    "asyncpg==0.29.0",
                    "aiosqlite==0.20.0",
                    "passlib[bcrypt]==1.7.4",
                    "python-jose[cryptography]==3.3.0",
                    "supervisor>=4.2.5",
                    "psutil>=5.9.0",
                    "httpx>=0.25.2"
                ]

                for package in critical_packages:
                    logger.info(f"ğŸ“¦ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° {package}...")
                    self.run_command(f"{venv_pip} install {package}")

            logger.info("âœ… Python Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚Ğ¸ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ñ‹")
            return True

        except Exception as e:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Python Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹: {e}")
            return False

    async def apply_database_migrations(self):
        """ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…"""
        logger.info("ğŸ”§ ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹ Ğ±Ğ°Ğ·Ñ‹ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…...")

        try:
            venv_python = self.venv_dir / "bin" / "python"

            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ Ñ„Ğ°Ğ¹Ğ»Ğ¾Ğ² Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹
            migrations_dir = self.app_dir / "database" / "migrations"
            if not migrations_dir.exists():
                logger.warning("âš ï¸ Ğ”Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ñ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹ Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°, ÑĞ¾Ğ·Ğ´Ğ°ĞµĞ¼ Ğ±Ğ°Ğ·Ğ¾Ğ²ÑƒÑ ÑÑ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ñƒ...")
                migrations_dir.mkdir(parents=True, exist_ok=True)

                # Ğ¡Ğ¾Ğ·Ğ´Ğ°ĞµĞ¼ __init__.py
                (migrations_dir / "__init__.py").write_text("# ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ´Ğ»Ñ Telegram Channel Finder Bot")

            # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸
            manage_migrations = self.app_dir / "manage_migrations.py"
            if manage_migrations.exists():
                logger.info("ğŸ“Š ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹...")
                result = self.run_command(f"{venv_python} manage_migrations.py status", check=False)

                logger.info("ğŸš€ ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹...")
                result = self.run_command(f"{venv_python} manage_migrations.py migrate", check=False)

                if result.returncode == 0:
                    logger.info("âœ… ĞœĞ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸ Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ñ‹ ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾")
                else:
                    logger.warning("âš ï¸ Ğ’Ğ¾Ğ·Ğ¼Ğ¾Ğ¶Ğ½Ñ‹ Ğ¿Ñ€Ğ¾Ğ±Ğ»ĞµĞ¼Ñ‹ Ñ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸ÑĞ¼Ğ¸, Ğ½Ğ¾ Ğ¿Ñ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼...")
            else:
                logger.warning("âš ï¸ Ğ¤Ğ°Ğ¹Ğ» manage_migrations.py Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")

            return True

        except Exception as e:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹: {e}")
            logger.info("ğŸ”„ ĞŸÑ€Ğ¾Ğ´Ğ¾Ğ»Ğ¶Ğ°ĞµĞ¼ Ğ±ĞµĞ· Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹...")
            return True

    def setup_supervisor(self):
        """ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¸Ñ‚ÑŒ Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑÑ‚Ğ¸Ñ‚ÑŒ Supervisor"""
        logger.info("ğŸ“Š ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Supervisor...")

        try:
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ Ğ½Ğ°Ğ»Ğ¸Ñ‡Ğ¸Ğµ ĞºĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ğ¸
            supervisor_config = self.app_dir / "supervisord_production.conf"
            if not supervisor_config.exists():
                logger.error("âŒ Ğ¤Ğ°Ğ¹Ğ» supervisord_production.conf Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")
                return False

            # ĞÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑÑ‹
            self.stop_existing_processes()

            # Ğ—Ğ°Ğ¿ÑƒÑĞºĞ°ĞµĞ¼ supervisord
            venv_supervisord = self.venv_dir / "bin" / "supervisord"
            if venv_supervisord.exists():
                supervisord_cmd = str(venv_supervisord)
            else:
                supervisord_cmd = "supervisord"

            logger.info("ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº Supervisor...")
            self.run_command(f"{supervisord_cmd} -c {supervisor_config}", check=False)

            # Ğ–Ğ´ĞµĞ¼ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸
            time.sleep(10)

            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ÑÑ‚Ğ°Ñ‚ÑƒÑ
            return self.check_supervisor_status()

        except Exception as e:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Supervisor: {e}")
            return False

    def stop_existing_processes(self):
        """ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ¸Ñ‚ÑŒ ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ğµ Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑÑ‹"""
        logger.info("ğŸ›‘ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑÑƒÑ‰ĞµÑÑ‚Ğ²ÑƒÑÑ‰Ğ¸Ñ… Ğ¿Ñ€Ğ¾Ñ†ĞµÑÑĞ¾Ğ²...")

        processes_to_stop = [
            "python main.py",
            "python run_admin.py",
            "python production_migration_watcher.py",
            "python production_data_sync.py",
            "python production_health_monitor.py",
            "supervisord"
        ]

        for process in processes_to_stop:
            try:
                self.run_command(f"pkill -f '{process}'", check=False)
                logger.info(f"ğŸ”ª ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²Ğ»ĞµĞ½: {process}")
            except:
                pass

        # ĞÑ‡Ğ¸Ñ‰Ğ°ĞµĞ¼ Ñ„Ğ°Ğ¹Ğ»Ñ‹ supervisor
        supervisor_files = ["/tmp/supervisord.pid", "/tmp/supervisor.sock"]
        for file_path in supervisor_files:
            try:
                Path(file_path).unlink(missing_ok=True)
            except:
                pass

    def check_supervisor_status(self):
        """ĞŸÑ€Ğ¾Ğ²ĞµÑ€Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ Supervisor"""
        logger.info("ğŸ“‹ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²...")

        try:
            supervisor_config = self.app_dir / "supervisord_production.conf"
            venv_supervisorctl = self.venv_dir / "bin" / "supervisorctl"

            if venv_supervisorctl.exists():
                supervisorctl_cmd = str(venv_supervisorctl)
            else:
                supervisorctl_cmd = "supervisorctl"

            result = self.run_command(f"{supervisorctl_cmd} -c {supervisor_config} status", check=False)

            if result.returncode == 0:
                logger.info("ğŸ“Š Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²:")
                for line in result.stdout.strip().split('\n'):
                    if line.strip():
                        logger.info(f"   {line}")
                return True
            else:
                logger.error("âŒ ĞĞµ ÑƒĞ´Ğ°Ğ»Ğ¾ÑÑŒ Ğ¿Ğ¾Ğ»ÑƒÑ‡Ğ¸Ñ‚ÑŒ ÑÑ‚Ğ°Ñ‚ÑƒÑ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²")
                return False

        except Exception as e:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ¸ ÑÑ‚Ğ°Ñ‚ÑƒÑĞ°: {e}")
            return False

    async def run_full_installation(self):
        """Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºÑƒ production ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹"""
        logger.info("ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ production ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹...")

        installation_start = time.time()

        try:
            # 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹
            if not self.check_system_requirements():
                logger.error("âŒ Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ½Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ñ‹")
                return False

            # 2. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
            if not self.install_system_dependencies():
                logger.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹")
                return False

            # 3. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹
            if not self.create_directories():
                logger.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹")
                return False

            # 4. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
            if not self.setup_virtual_environment():
                logger.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ")
                return False

            # 5. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Python Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
            if not self.install_python_dependencies():
                logger.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Python Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹")
                return False

            # 6. ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹
            if not await self.apply_database_migrations():
                logger.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹")
                return False

            # 7. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞº Supervisor
            if not self.setup_supervisor():
                logger.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Supervisor")
                return False

            # 8. Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
            await asyncio.sleep(15)  # Ğ–Ğ´ĞµĞ¼ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²

            installation_time = time.time() - installation_start

            logger.info("ğŸ‰ Ğ£Ğ¡Ğ¢ĞĞĞĞ’ĞšĞ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ!")
            logger.info(f"â±ï¸ Ğ’Ñ€ĞµĞ¼Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸: {installation_time:.1f} ÑĞµĞºÑƒĞ½Ğ´")
            logger.info("ğŸŒ ĞĞ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ: http://185.207.66.201:8080")
            logger.info("ğŸ”‘ Ğ›Ğ¾Ğ³Ğ¸Ğ½: admin / admin123")
            logger.info("ğŸ“Š Ğ’ÑĞµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ Ğ¿Ğ¾Ğ´ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸ĞµĞ¼ Supervisor")
            logger.info("ğŸ”„ Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ° Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ!")

            return True

        except Exception as e:
            logger.error(f"âŒ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸: {e}")
            return False

    def run_simple_commands(self, command):
        """Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ±ĞµĞ· ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸"""
        try:
            if command == "status":
                # Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
                logger.info("ğŸ“‹ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²...")
                supervisor_config = self.app_dir / "supervisord_production.conf"
                if supervisor_config.exists():
                    self.run_command(f"supervisorctl -c {supervisor_config} status", check=False)
                else:
                    logger.error("âŒ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Supervisor Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°")

            elif command == "restart":
                # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
                logger.info("ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²...")
                supervisor_config = self.app_dir / "supervisord_production.conf"
                if supervisor_config.exists():
                    self.run_command(f"supervisorctl -c {supervisor_config} restart all", check=False)
                else:
                    logger.error("âŒ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Supervisor Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°")

            elif command == "stop":
                # ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
                logger.info("ğŸ›‘ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²...")
                self.stop_existing_processes()

            elif command == "logs":
                # ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ»Ğ¾Ğ³Ğ¾Ğ²
                service = sys.argv[2] if len(sys.argv) > 2 else None
                if service:
                    log_file = self.logs_dir / f"{service}.log"
                    if log_file.exists():
                        self.run_command(f"tail -f {log_file}", check=False)
                    else:
                        logger.error(f"âŒ Ğ›Ğ¾Ğ³ Ñ„Ğ°Ğ¹Ğ» {log_file} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")
                else:
                    logger.info("ğŸ“„ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ğ»Ğ¾Ğ³ Ñ„Ğ°Ğ¹Ğ»Ñ‹:")
                    for log_file in self.logs_dir.glob("*.log"):
                        logger.info(f"   {log_file.name}")

            elif command == "dashboard":
                # Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ± Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸
                logger.info("ğŸŒ ĞĞ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ğ¿Ğ¾ Ğ°Ğ´Ñ€ĞµÑÑƒ:")
                logger.info("   http://185.207.66.201:8080")
                logger.info("   Ğ›Ğ¾Ğ³Ğ¸Ğ½: admin")
                logger.info("   ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ: admin123")

            else:
                logger.error(f"âŒ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°: {command}")
                return False

            return True

        except Exception as e:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ {command}: {e}")
            return False

def show_help():
    """ĞŸĞ¾ĞºĞ°Ğ·Ğ°Ñ‚ÑŒ ÑĞ¿Ñ€Ğ°Ğ²ĞºÑƒ"""
    help_text = """
ğŸ› ï¸ PRODUCTION STARTUP COMMANDS:

ğŸ“‹ ĞÑĞ½Ğ¾Ğ²Ğ½Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹:
  python production_startup.py                  - ĞĞ²Ñ‚Ğ¾Ğ¼Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞº
  python production_startup.py deploy           - ĞŸĞ¾Ğ»Ğ½Ğ°Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ñ Ğ´ĞµĞ¿Ğ»Ğ¾ĞµĞ¼
  python production_startup.py install          - Ğ¢Ğ¾Ğ»ÑŒĞºĞ¾ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
  python production_startup.py status           - Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
  python production_startup.py restart          - ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
  python production_startup.py stop             - ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
  python production_startup.py logs [service]   - ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ»Ğ¾Ğ³Ğ¾Ğ²

ğŸ”§ Ğ£Ğ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ğµ:
  python production_startup.py migrate          - ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸
  python production_startup.py health           - ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹
  python production_startup.py dashboard        - Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ± Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸

ğŸ¯ Ğ”Ğ»Ñ Dokploy:
  ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ·Ğ°Ğ¿ÑƒÑĞºĞ°: python production_startup.py deploy

ğŸŒ ĞŸĞ¾ÑĞ»Ğµ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸:
  ĞĞ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ: http://185.207.66.201:8080
  Ğ›Ğ¾Ğ³Ğ¸Ğ½: admin / admin123
"""
    print(help_text)

    async def run_full_installation(self):
        """Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ¿Ğ¾Ğ»Ğ½ÑƒÑ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºÑƒ production ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹"""
        logger.info("ğŸš€ Ğ—Ğ°Ğ¿ÑƒÑĞº Ğ¿Ğ¾Ğ»Ğ½Ğ¾Ğ¹ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ production ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹...")

        installation_start = time.time()

        try:
            # 1. ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğ¹
            if not self.check_system_requirements():
                logger.error("âŒ Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ğµ Ñ‚Ñ€ĞµĞ±Ğ¾Ğ²Ğ°Ğ½Ğ¸Ñ Ğ½Ğµ Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ñ‹")
                return False

            # 2. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
            if not self.install_system_dependencies():
                logger.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ ÑĞ¸ÑÑ‚ĞµĞ¼Ğ½Ñ‹Ñ… Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹")
                return False

            # 3. Ğ¡Ğ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ğµ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹
            if not self.create_directories():
                logger.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑĞ¾Ğ·Ğ´Ğ°Ğ½Ğ¸Ñ Ğ´Ğ¸Ñ€ĞµĞºÑ‚Ğ¾Ñ€Ğ¸Ğ¹")
                return False

            # 4. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
            if not self.setup_virtual_environment():
                logger.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Ğ²Ğ¸Ñ€Ñ‚ÑƒĞ°Ğ»ÑŒĞ½Ğ¾Ğ³Ğ¾ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ")
                return False

            # 5. Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Python Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹
            if not self.install_python_dependencies():
                logger.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸ Python Ğ·Ğ°Ğ²Ğ¸ÑĞ¸Ğ¼Ğ¾ÑÑ‚ĞµĞ¹")
                return False

            # 6. ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹
            if not await self.apply_database_migrations():
                logger.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ¿Ñ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹")
                return False

            # 7. ĞĞ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ° Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞº Supervisor
            if not self.setup_supervisor():
                logger.error("âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ½Ğ°ÑÑ‚Ñ€Ğ¾Ğ¹ĞºĞ¸ Supervisor")
                return False

            # 8. Ğ¤Ğ¸Ğ½Ğ°Ğ»ÑŒĞ½Ğ°Ñ Ğ¿Ñ€Ğ¾Ğ²ĞµÑ€ĞºĞ°
            await asyncio.sleep(15)  # Ğ–Ğ´ĞµĞ¼ Ğ¸Ğ½Ğ¸Ñ†Ğ¸Ğ°Ğ»Ğ¸Ğ·Ğ°Ñ†Ğ¸Ğ¸ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²

            installation_time = time.time() - installation_start

            logger.info("ğŸ‰ Ğ£Ğ¡Ğ¢ĞĞĞĞ’ĞšĞ Ğ—ĞĞ’Ğ•Ğ Ğ¨Ğ•ĞĞ Ğ£Ğ¡ĞŸĞ•Ğ¨ĞĞ!")
            logger.info(f"â±ï¸ Ğ’Ñ€ĞµĞ¼Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸: {installation_time:.1f} ÑĞµĞºÑƒĞ½Ğ´")
            logger.info("ğŸŒ ĞĞ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ: http://185.207.66.201:8080")
            logger.info("ğŸ”‘ Ğ›Ğ¾Ğ³Ğ¸Ğ½: admin / admin123")
            logger.info("ğŸ“Š Ğ’ÑĞµ ÑĞµÑ€Ğ²Ğ¸ÑÑ‹ Ğ¿Ğ¾Ğ´ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸ĞµĞ¼ Supervisor")
            logger.info("ğŸ”„ Ğ¡Ğ¸ÑÑ‚ĞµĞ¼Ğ° Ğ³Ğ¾Ñ‚Ğ¾Ğ²Ğ° Ğº Ñ€Ğ°Ğ±Ğ¾Ñ‚Ğµ!")

            return True

        except Exception as e:
            logger.error(f"âŒ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ° ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸: {e}")
            return False

    def run_simple_commands(self, command):
        """Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½Ğ¸Ñ‚ÑŒ Ğ¿Ñ€Ğ¾ÑÑ‚Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ Ğ±ĞµĞ· ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ¸"""
        try:
            if command == "status":
                # Ğ¡Ñ‚Ğ°Ñ‚ÑƒÑ ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
                logger.info("ğŸ“‹ ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑÑ‚Ğ°Ñ‚ÑƒÑĞ° ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²...")
                supervisor_config = self.app_dir / "supervisord_production.conf"
                if supervisor_config.exists():
                    self.run_command(f"supervisorctl -c {supervisor_config} status", check=False)
                else:
                    logger.error("âŒ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Supervisor Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°")

            elif command == "restart":
                # ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
                logger.info("ğŸ”„ ĞŸĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞº Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²...")
                supervisor_config = self.app_dir / "supervisord_production.conf"
                if supervisor_config.exists():
                    self.run_command(f"supervisorctl -c {supervisor_config} restart all", check=False)
                else:
                    logger.error("âŒ ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ Supervisor Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½Ğ°")

            elif command == "stop":
                # ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²
                logger.info("ğŸ›‘ ĞÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ²ÑĞµÑ… ÑĞµÑ€Ğ²Ğ¸ÑĞ¾Ğ²...")
                self.stop_existing_processes()

            elif command == "logs":
                # ĞŸÑ€Ğ¾ÑĞ¼Ğ¾Ñ‚Ñ€ Ğ»Ğ¾Ğ³Ğ¾Ğ²
                service = sys.argv[2] if len(sys.argv) > 2 else None
                if service:
                    log_file = self.logs_dir / f"{service}.log"
                    if log_file.exists():
                        self.run_command(f"tail -f {log_file}", check=False)
                    else:
                        logger.error(f"âŒ Ğ›Ğ¾Ğ³ Ñ„Ğ°Ğ¹Ğ» {log_file} Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")
                else:
                    logger.info("ğŸ“„ Ğ”Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ñ‹Ğµ Ğ»Ğ¾Ğ³ Ñ„Ğ°Ğ¹Ğ»Ñ‹:")
                    for log_file in self.logs_dir.glob("*.log"):
                        logger.info(f"   {log_file.name}")

            elif command == "dashboard":
                # Ğ˜Ğ½Ñ„Ğ¾Ñ€Ğ¼Ğ°Ñ†Ğ¸Ñ Ğ¾Ğ± Ğ°Ğ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»Ğ¸
                logger.info("ğŸŒ ĞĞ´Ğ¼Ğ¸Ğ½-Ğ¿Ğ°Ğ½ĞµĞ»ÑŒ Ğ´Ğ¾ÑÑ‚ÑƒĞ¿Ğ½Ğ° Ğ¿Ğ¾ Ğ°Ğ´Ñ€ĞµÑÑƒ:")
                logger.info("   http://185.207.66.201:8080")
                logger.info("   Ğ›Ğ¾Ğ³Ğ¸Ğ½: admin")
                logger.info("   ĞŸĞ°Ñ€Ğ¾Ğ»ÑŒ: admin123")

            else:
                logger.error(f"âŒ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°: {command}")
                return False

            return True

        except Exception as e:
            logger.error(f"âŒ ĞÑˆĞ¸Ğ±ĞºĞ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ {command}: {e}")
            return False

async def main():
    """ĞÑĞ½Ğ¾Ğ²Ğ½Ğ°Ñ Ñ„ÑƒĞ½ĞºÑ†Ğ¸Ñ"""
    installer = ProductionInstaller()
    installer.print_banner()

    # Ğ£ÑÑ‚Ğ°Ğ½Ğ°Ğ²Ğ»Ğ¸Ğ²Ğ°ĞµĞ¼ Ğ¿ĞµÑ€ĞµĞ¼ĞµĞ½Ğ½Ñ‹Ğµ Ğ¾ĞºÑ€ÑƒĞ¶ĞµĞ½Ğ¸Ñ
    os.environ["ENVIRONMENT"] = "production"
    os.environ["PYTHONPATH"] = "/app"
    os.environ["PYTHONUNBUFFERED"] = "1"

    # ĞĞ¿Ñ€ĞµĞ´ĞµĞ»ÑĞµĞ¼ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñƒ
    command = sys.argv[1] if len(sys.argv) > 1 else "deploy"

    if command in ["help", "-h", "--help"]:
        show_help()
        return

    logger.info(f"ğŸ¯ Ğ’Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ¸Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹: {command}")

    try:
        if command in ["deploy", "install", "start", ""]:
            # ĞŸĞ¾Ğ»Ğ½Ğ°Ñ ÑƒÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ¸ Ğ·Ğ°Ğ¿ÑƒÑĞº
            success = await installer.run_full_installation()
            if not success:
                logger.error("âŒ Ğ£ÑÑ‚Ğ°Ğ½Ğ¾Ğ²ĞºĞ° Ğ·Ğ°Ğ²ĞµÑ€ÑˆĞ¸Ğ»Ğ°ÑÑŒ Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°Ğ¼Ğ¸")
                sys.exit(1)

        elif command in ["status", "restart", "stop", "logs", "dashboard"]:
            # ĞŸÑ€Ğ¾ÑÑ‚Ñ‹Ğµ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ
            success = installer.run_simple_commands(command)
            if not success:
                sys.exit(1)

        elif command == "migrate":
            # ĞŸÑ€Ğ¸Ğ¼ĞµĞ½Ğ¸Ñ‚ÑŒ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¸
            logger.info("ğŸ”§ ĞŸÑ€Ğ¸Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ğµ Ğ¼Ğ¸Ğ³Ñ€Ğ°Ñ†Ğ¸Ğ¹...")
            await installer.apply_database_migrations()

        elif command == "health":
            # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ
            logger.info("ğŸ” ĞŸÑ€Ğ¾Ğ²ĞµÑ€ĞºĞ° ÑĞ¾ÑÑ‚Ğ¾ÑĞ½Ğ¸Ñ ÑĞ¸ÑÑ‚ĞµĞ¼Ñ‹...")
            try:
                from production_health_monitor import ProductionHealthMonitor
                monitor = ProductionHealthMonitor()
                report = await monitor.perform_health_check()
                logger.info(f"ĞĞ±Ñ‰Ğ¸Ğ¹ ÑÑ‚Ğ°Ñ‚ÑƒÑ: {report['overall_status']}")
            except ImportError:
                logger.warning("âš ï¸ ĞœĞ¾Ğ´ÑƒĞ»ÑŒ Ğ¼Ğ¾Ğ½Ğ¸Ñ‚Ğ¾Ñ€Ğ¸Ğ½Ğ³Ğ° Ğ½Ğµ Ğ½Ğ°Ğ¹Ğ´ĞµĞ½")

        else:
            logger.error(f"âŒ ĞĞµĞ¸Ğ·Ğ²ĞµÑÑ‚Ğ½Ğ°Ñ ĞºĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ°: {command}")
            show_help()
            sys.exit(1)

        logger.info("âœ… ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾")

    except KeyboardInterrupt:
        logger.info("ğŸ‘‹ ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€ĞµÑ€Ğ²Ğ°Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼")
        sys.exit(1)
    except Exception as e:
        logger.error(f"âŒ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)

        logger.info("âœ… ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ²Ñ‹Ğ¿Ğ¾Ğ»Ğ½ĞµĞ½Ğ° ÑƒÑĞ¿ĞµÑˆĞ½Ğ¾")

    except KeyboardInterrupt:
        logger.info("ğŸ‘‹ ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€ĞµÑ€Ğ²Ğ°Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼")
        sys.exit(1)
    except Exception as e:
        logger.error(f"âŒ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)

if __name__ == "__main__":
    try:
        asyncio.run(main())
    except KeyboardInterrupt:
        logger.info("ğŸ‘‹ ĞĞ¿ĞµÑ€Ğ°Ñ†Ğ¸Ñ Ğ¿Ñ€ĞµÑ€Ğ²Ğ°Ğ½Ğ° Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¼")
        sys.exit(1)
    except Exception as e:
        logger.error(f"âŒ ĞšÑ€Ğ¸Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ°Ñ Ğ¾ÑˆĞ¸Ğ±ĞºĞ°: {e}")
        sys.exit(1)
