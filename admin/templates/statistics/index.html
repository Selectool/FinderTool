{% extends "base.html" %} {% block title %}–î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞{% endblock %} {%
block extra_head %}
<style>
	.stats-card {
		border: none;
		border-radius: 15px;
		box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
		transition: transform 0.2s ease-in-out;
	}

	.stats-card:hover {
		transform: translateY(-2px);
	}

	.metric-value {
		font-size: 2.5rem;
		font-weight: 700;
		margin-bottom: 0.5rem;
	}

	.metric-label {
		font-size: 0.9rem;
		color: #6c757d;
		text-transform: uppercase;
		letter-spacing: 0.5px;
	}

	.trend-up {
		color: #28a745;
	}

	.trend-down {
		color: #dc3545;
	}

	.trend-neutral {
		color: #6c757d;
	}

	.status-indicator {
		width: 12px;
		height: 12px;
		border-radius: 50%;
		display: inline-block;
		margin-right: 8px;
	}

	.status-healthy {
		background-color: #28a745;
	}

	.status-warning {
		background-color: #ffc107;
	}

	.status-error {
		background-color: #dc3545;
	}

	.refresh-btn {
		position: fixed;
		bottom: 30px;
		right: 30px;
		z-index: 1000;
		border-radius: 50%;
		width: 60px;
		height: 60px;
		box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
	}

	.section-header {
		border-bottom: 3px solid #007bff;
		padding-bottom: 10px;
		margin-bottom: 25px;
	}

	.progress-custom {
		height: 8px;
		border-radius: 4px;
	}

	.table-stats {
		font-size: 0.9rem;
	}

	.table-stats th {
		border-top: none;
		font-weight: 600;
		color: #495057;
		background-color: #f8f9fa;
	}

	.auto-refresh-indicator {
		position: fixed;
		top: 20px;
		right: 20px;
		z-index: 1001;
		padding: 8px 16px;
		background: rgba(0, 123, 255, 0.9);
		color: white;
		border-radius: 20px;
		font-size: 0.8rem;
		display: none;
	}
</style>
{% endblock %} {% block content %}
<div class="container-fluid">
	<!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
	<div class="d-flex justify-content-between align-items-center mb-4">
		<div>
			<h1 class="h3 mb-0">üìä –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h1>
			<p class="text-muted mb-0">Production-ready –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–∏—Å—Ç–µ–º—ã</p>
		</div>
		<div>
			<button
				class="btn btn-outline-primary btn-sm me-2"
				onclick="refreshStats()"
			>
				<i class="fas fa-sync-alt"></i> –û–±–Ω–æ–≤–∏—Ç—å
			</button>
			<button
				class="btn btn-outline-secondary btn-sm"
				onclick="toggleAutoRefresh()"
			>
				<i class="fas fa-clock"></i>
				<span id="autoRefreshText">–ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ</span>
			</button>
		</div>
	</div>

	<!-- –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
	<div id="autoRefreshIndicator" class="auto-refresh-indicator">
		<i class="fas fa-sync-alt fa-spin"></i> –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö...
	</div>

	<!-- –û—Å–Ω–æ–≤–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
	<div class="row mb-4">
		<div class="col-md-3 mb-3">
			<div class="card stats-card bg-primary text-white">
				<div class="card-body text-center">
					<div class="metric-value">{{ overview.total_users }}</div>
					<div class="metric-label">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</div>
					<small class="d-block mt-2">
						<i class="fas fa-arrow-up"></i> +{{ users.new_today }} —Å–µ–≥–æ–¥–Ω—è
					</small>
				</div>
			</div>
		</div>
		<div class="col-md-3 mb-3">
			<div class="card stats-card bg-success text-white">
				<div class="card-body text-center">
					<div class="metric-value">{{ overview.active_subscribers }}</div>
					<div class="metric-label">–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤</div>
					<small class="d-block mt-2">
						{{ (overview.active_subscribers / overview.total_users * 100) |
						round(1) if overview.total_users > 0 else 0 }}% –æ—Ç –æ–±—â–µ–≥–æ —á–∏—Å–ª–∞
					</small>
				</div>
			</div>
		</div>
		<div class="col-md-3 mb-3">
			<div class="card stats-card bg-info text-white">
				<div class="card-body text-center">
					<div class="metric-value">{{ overview.total_requests }}</div>
					<div class="metric-label">–í—Å–µ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤</div>
					<small class="d-block mt-2">
						<i class="fas fa-arrow-up"></i> +{{ requests.today }} —Å–µ–≥–æ–¥–Ω—è
					</small>
				</div>
			</div>
		</div>
		<div class="col-md-3 mb-3">
			<div class="card stats-card bg-warning text-white">
				<div class="card-body text-center">
					<div class="metric-value">{{ payments.total.amount }}‚ÇΩ</div>
					<div class="metric-label">–û–±—â–∏–π –¥–æ—Ö–æ–¥</div>
					<small class="d-block mt-2">
						<i class="fas fa-arrow-up"></i> +{{ payments.today.amount }}‚ÇΩ
						—Å–µ–≥–æ–¥–Ω—è
					</small>
				</div>
			</div>
		</div>
	</div>

	<!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
	<div class="row mb-4">
		<div class="col-md-6">
			<div class="card stats-card">
				<div class="card-header">
					<h5 class="section-header mb-0">
						<i class="fas fa-users me-2"></i>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
					</h5>
				</div>
				<div class="card-body">
					<div class="row text-center">
						<div class="col-4">
							<div class="h4 text-primary">{{ users.total }}</div>
							<small class="text-muted">–í—Å–µ–≥–æ</small>
						</div>
						<div class="col-4">
							<div class="h4 text-success">{{ users.active_subscribers }}</div>
							<small class="text-muted">–ü–æ–¥–ø–∏—Å—á–∏–∫–∏</small>
						</div>
						<div class="col-4">
							<div class="h4 text-warning">{{ users.unlimited }}</div>
							<small class="text-muted">–ë–µ–∑–ª–∏–º–∏—Ç</small>
						</div>
					</div>
					<hr />
					<div class="row text-center">
						<div class="col-4">
							<div class="h6 text-info">{{ users.new_today }}</div>
							<small class="text-muted">–°–µ–≥–æ–¥–Ω—è</small>
						</div>
						<div class="col-4">
							<div class="h6 text-info">{{ users.new_week }}</div>
							<small class="text-muted">–ó–∞ –Ω–µ–¥–µ–ª—é</small>
						</div>
						<div class="col-4">
							<div class="h6 text-info">{{ users.new_month }}</div>
							<small class="text-muted">–ó–∞ –º–µ—Å—è—Ü</small>
						</div>
					</div>
					{% if users.blocked > 0 %}
					<div class="alert alert-warning mt-3 mb-0">
						<i class="fas fa-exclamation-triangle me-2"></i>
						–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: {{ users.blocked }}
					</div>
					{% endif %}
				</div>
			</div>
		</div>

		<div class="col-md-6">
			<div class="card stats-card">
				<div class="card-header">
					<h5 class="section-header mb-0">
						<i class="fas fa-search me-2"></i>–ó–∞–ø—Ä–æ—Å—ã
					</h5>
				</div>
				<div class="card-body">
					<div class="row text-center">
						<div class="col-4">
							<div class="h4 text-primary">{{ requests.total }}</div>
							<small class="text-muted">–í—Å–µ–≥–æ</small>
						</div>
						<div class="col-4">
							<div class="h4 text-success">{{ requests.today }}</div>
							<small class="text-muted">–°–µ–≥–æ–¥–Ω—è</small>
						</div>
						<div class="col-4">
							<div class="h4 text-info">
								{{ requests.avg_per_user | round(1) }}
							</div>
							<small class="text-muted">–ù–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</small>
						</div>
					</div>
					<hr />
					<div class="row text-center">
						<div class="col-6">
							<div class="h6 text-warning">{{ requests.week }}</div>
							<small class="text-muted">–ó–∞ –Ω–µ–¥–µ–ª—é</small>
						</div>
						<div class="col-6">
							<div class="h6 text-warning">{{ requests.month }}</div>
							<small class="text-muted">–ó–∞ –º–µ—Å—è—Ü</small>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–ª–∞—Ç–µ–∂–µ–π -->
	<div class="row mb-4">
		<div class="col-12">
			<div class="card stats-card">
				<div class="card-header">
					<h5 class="section-header mb-0">
						<i class="fas fa-credit-card me-2"></i>–ü–ª–∞—Ç–µ–∂–∏ –∏ –¥–æ—Ö–æ–¥—ã
					</h5>
				</div>
				<div class="card-body">
					<div class="row">
						<!-- –°–µ–≥–æ–¥–Ω—è -->
						<div class="col-md-3">
							<div class="text-center p-3 border-end">
								<h6 class="text-muted mb-3">–°–µ–≥–æ–¥–Ω—è</h6>
								<div class="h4 text-success">{{ payments.today.amount }}‚ÇΩ</div>
								<div class="small text-muted">
									{{ payments.today.successful }}/{{ payments.today.count }}
									–ø–ª–∞—Ç–µ–∂–µ–π
								</div>
								{% if payments.today.count > 0 %}
								<div class="progress progress-custom mt-2">
									<div
										class="progress-bar bg-success"
										style="width: {{ (payments.today.successful / payments.today.count * 100) | round }}%"
									></div>
								</div>
								<small class="text-muted"
									>{{ (payments.today.successful / payments.today.count * 100) |
									round }}% —É—Å–ø–µ—à–Ω—ã—Ö</small
								>
								{% endif %}
							</div>
						</div>

						<!-- –ó–∞ –Ω–µ–¥–µ–ª—é -->
						<div class="col-md-3">
							<div class="text-center p-3 border-end">
								<h6 class="text-muted mb-3">–ó–∞ –Ω–µ–¥–µ–ª—é</h6>
								<div class="h4 text-info">{{ payments.week.amount }}‚ÇΩ</div>
								<div class="small text-muted">
									{{ payments.week.successful }}/{{ payments.week.count }}
									–ø–ª–∞—Ç–µ–∂–µ–π
								</div>
								{% if payments.week.count > 0 %}
								<div class="progress progress-custom mt-2">
									<div
										class="progress-bar bg-info"
										style="width: {{ (payments.week.successful / payments.week.count * 100) | round }}%"
									></div>
								</div>
								<small class="text-muted"
									>{{ (payments.week.successful / payments.week.count * 100) |
									round }}% —É—Å–ø–µ—à–Ω—ã—Ö</small
								>
								{% endif %}
							</div>
						</div>

						<!-- –ó–∞ –º–µ—Å—è—Ü -->
						<div class="col-md-3">
							<div class="text-center p-3 border-end">
								<h6 class="text-muted mb-3">–ó–∞ –º–µ—Å—è—Ü</h6>
								<div class="h4 text-warning">{{ payments.month.amount }}‚ÇΩ</div>
								<div class="small text-muted">
									{{ payments.month.successful }}/{{ payments.month.count }}
									–ø–ª–∞—Ç–µ–∂–µ–π
								</div>
								{% if payments.month.count > 0 %}
								<div class="progress progress-custom mt-2">
									<div
										class="progress-bar bg-warning"
										style="width: {{ (payments.month.successful / payments.month.count * 100) | round }}%"
									></div>
								</div>
								<small class="text-muted"
									>{{ (payments.month.successful / payments.month.count * 100) |
									round }}% —É—Å–ø–µ—à–Ω—ã—Ö</small
								>
								{% endif %}
							</div>
						</div>

						<!-- –í—Å–µ–≥–æ -->
						<div class="col-md-3">
							<div class="text-center p-3">
								<h6 class="text-muted mb-3">–í—Å–µ–≥–æ</h6>
								<div class="h4 text-primary">{{ payments.total.amount }}‚ÇΩ</div>
								<div class="small text-muted">
									{{ payments.total.successful }}/{{ payments.total.count }}
									–ø–ª–∞—Ç–µ–∂–µ–π
								</div>
								{% if payments.total.count > 0 %}
								<div class="progress progress-custom mt-2">
									<div
										class="progress-bar bg-primary"
										style="width: {{ calculated.payment_success_rate }}%"
									></div>
								</div>
								<small class="text-muted"
									>{{ calculated.payment_success_rate }}% —É—Å–ø–µ—à–Ω—ã—Ö</small
								>
								{% endif %}
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- –¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –∏ —Å–∏—Å—Ç–µ–º–∞ -->
	<div class="row mb-4">
		<div class="col-md-8">
			<div class="card stats-card">
				<div class="card-header">
					<h5 class="section-header mb-0">
						<i class="fas fa-trophy me-2"></i>–¢–æ–ø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
					</h5>
				</div>
				<div class="card-body">
					{% if top_users %}
					<div class="table-responsive">
						<table class="table table-stats table-hover">
							<thead>
								<tr>
									<th>#</th>
									<th>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</th>
									<th>–ó–∞–ø—Ä–æ—Å–æ–≤</th>
									<th>–°—Ç–∞—Ç—É—Å</th>
									<th>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
								</tr>
							</thead>
							<tbody>
								{% for user in top_users %}
								<tr>
									<td>{{ loop.index }}</td>
									<td>
										<div class="d-flex align-items-center">
											<div
												class="avatar-sm bg-primary text-white rounded-circle d-flex align-items-center justify-content-center me-2"
											>
												{{ user.username[0] if user.username else 'U' }}
											</div>
											<div>
												<div class="fw-bold">
													{{ user.username or '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' }}
												</div>
												<small class="text-muted">ID: {{ user.user_id }}</small>
											</div>
										</div>
									</td>
									<td>
										<span class="badge bg-info">{{ user.request_count }}</span>
									</td>
									<td>
										{% if user.is_subscriber %}
										<span class="badge bg-success">–ü–æ–¥–ø–∏—Å—á–∏–∫</span>
										{% elif user.is_unlimited %}
										<span class="badge bg-warning">–ë–µ–∑–ª–∏–º–∏—Ç</span>
										{% elif user.is_blocked %}
										<span class="badge bg-danger">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
										{% else %}
										<span class="badge bg-secondary">–û–±—ã—á–Ω—ã–π</span>
										{% endif %}
									</td>
									<td>
										<small class="text-muted"
											>{{ user.last_activity or '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}</small
										>
									</td>
								</tr>
								{% endfor %}
							</tbody>
						</table>
					</div>
					{% else %}
					<div class="text-center py-4">
						<i class="fas fa-users fa-3x text-muted mb-3"></i>
						<p class="text-muted">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è—Ö</p>
					</div>
					{% endif %}
				</div>
			</div>
		</div>

		<div class="col-md-4">
			<div class="card stats-card">
				<div class="card-header">
					<h5 class="section-header mb-0">
						<i class="fas fa-cog me-2"></i>–°–∏—Å—Ç–µ–º–∞
					</h5>
				</div>
				<div class="card-body">
					<div class="mb-3">
						<div class="d-flex justify-content-between align-items-center">
							<span>–°—Ç–∞—Ç—É—Å —Å–∏—Å—Ç–µ–º—ã</span>
							<span
								class="status-indicator {% if system.health_status == 'healthy' %}status-healthy{% elif system.health_status == 'warning' %}status-warning{% else %}status-error{% endif %}"
							></span>
						</div>
					</div>

					<div class="mb-3">
						<div class="d-flex justify-content-between align-items-center">
							<span>–ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö</span>
							<span
								class="badge {% if system.database_connected %}bg-success{% else %}bg-danger{% endif %}"
							>
								{% if system.database_connected %}–ü–æ–¥–∫–ª—é—á–µ–Ω–∞{% else
								%}–û—Ç–∫–ª—é—á–µ–Ω–∞{% endif %}
							</span>
						</div>
					</div>

					<div class="mb-3">
						<div class="d-flex justify-content-between align-items-center">
							<span>–ö–µ—à</span>
							<span class="text-muted">{{ system.cache_size }} –∑–∞–ø–∏—Å–µ–π</span>
						</div>
						<small class="text-muted">TTL: {{ system.cache_ttl }}—Å</small>
					</div>

					<div class="mb-3">
						<div class="d-flex justify-content-between align-items-center">
							<span>–í–∞–ª–∏–¥–∞—Ü–∏—è</span>
							<span
								class="badge {% if system.validation_enabled %}bg-success{% else %}bg-warning{% endif %}"
							>
								{% if system.validation_enabled %}–í–∫–ª—é—á–µ–Ω–∞{% else %}–û—Ç–∫–ª—é—á–µ–Ω–∞{%
								endif %}
							</span>
						</div>
					</div>

					<hr />

					<div class="mb-2">
						<small class="text-muted">–ü–æ—Å–ª–µ–¥–Ω–µ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ:</small>
						<div class="small">{{ timestamps.current_time }}</div>
					</div>

					<div class="mb-2">
						<small class="text-muted">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–∞:</small>
						<div class="small">
							{{ timestamps.generated_at[:19] if timestamps.generated_at else
							'–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' }}
						</div>
					</div>
				</div>
			</div>

			<!-- –†–∞—Å—Å—ã–ª–∫–∏ -->
			<div class="card stats-card mt-3">
				<div class="card-header">
					<h5 class="section-header mb-0">
						<i class="fas fa-bullhorn me-2"></i>–†–∞—Å—Å—ã–ª–∫–∏
					</h5>
				</div>
				<div class="card-body">
					<div class="row text-center">
						<div class="col-6">
							<div class="h5 text-primary">{{ broadcasts.total }}</div>
							<small class="text-muted">–í—Å–µ–≥–æ</small>
						</div>
						<div class="col-6">
							<div class="h5 text-success">{{ broadcasts.completed }}</div>
							<small class="text-muted">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</small>
						</div>
					</div>
					<hr />
					<div class="row text-center">
						<div class="col-6">
							<div class="h6 text-info">{{ broadcasts.sent }}</div>
							<small class="text-muted">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</small>
						</div>
						<div class="col-6">
							<div class="h6 text-danger">{{ broadcasts.failed }}</div>
							<small class="text-muted">–û—à–∏–±–∫–∏</small>
						</div>
					</div>
					{% if broadcasts.total > 0 %}
					<div class="progress progress-custom mt-3">
						<div
							class="progress-bar bg-success"
							style="width: {{ broadcasts.success_rate }}%"
						></div>
					</div>
					<small class="text-muted d-block text-center mt-1"
						>{{ broadcasts.success_rate }}% —É—Å–ø–µ—à–Ω—ã—Ö</small
					>
					{% endif %}
				</div>
			</div>
		</div>
	</div>

	<!-- –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏ -->
	<div class="row mb-4">
		<div class="col-12">
			<div class="card stats-card">
				<div class="card-header">
					<h5 class="section-header mb-0">
						<i class="fas fa-chart-bar me-2"></i>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç—Ä–∏–∫–∏
					</h5>
				</div>
				<div class="card-body">
					<div class="row text-center">
						<div class="col-md-3">
							<div class="p-3">
								<div class="h4 text-primary">
									{{ overview.conversion_rate | round(1) }}%
								</div>
								<small class="text-muted">–ö–æ–Ω–≤–µ—Ä—Å–∏—è –≤ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏</small>
							</div>
						</div>
						<div class="col-md-3">
							<div class="p-3">
								<div class="h4 text-success">
									{{ calculated.revenue_per_user }}‚ÇΩ
								</div>
								<small class="text-muted">–î–æ—Ö–æ–¥ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</small>
							</div>
						</div>
						<div class="col-md-3">
							<div class="p-3">
								<div class="h4 text-info">
									{{ overview.avg_requests_per_user | round(1) }}
								</div>
								<small class="text-muted">–ó–∞–ø—Ä–æ—Å–æ–≤ –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</small>
							</div>
						</div>
						<div class="col-md-3">
							<div class="p-3">
								<div class="h4 text-warning">
									{{ calculated.payment_success_rate }}%
								</div>
								<small class="text-muted">–£—Å–ø–µ—à–Ω–æ—Å—Ç—å –ø–ª–∞—Ç–µ–∂–µ–π</small>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</div>

<!-- –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è -->
<button
	class="btn btn-primary refresh-btn"
	onclick="refreshStats()"
	title="–û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É"
>
	<i class="fas fa-sync-alt"></i>
</button>

<script>
	let autoRefreshInterval = null
	let isAutoRefreshEnabled = false

	// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
	async function refreshStats() {
		const indicator = document.getElementById('autoRefreshIndicator')
		indicator.style.display = 'block'

		try {
			const response = await fetch('/statistics/api/data')
			const result = await response.json()

			if (result.success) {
				// –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö
				window.location.reload()
			} else {
				console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', result.error)
				alert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏: ' + result.error)
			}
		} catch (error) {
			console.error('–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞:', error)
			alert('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏')
		} finally {
			setTimeout(() => {
				indicator.style.display = 'none'
			}, 1000)
		}
	}

	// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
	function toggleAutoRefresh() {
		const button = document.getElementById('autoRefreshText')

		if (isAutoRefreshEnabled) {
			clearInterval(autoRefreshInterval)
			isAutoRefreshEnabled = false
			button.textContent = '–ê–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ'
		} else {
			autoRefreshInterval = setInterval(refreshStats, 60000) // –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
			isAutoRefreshEnabled = true
			button.textContent = '–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∞–≤—Ç–æ-–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ'
		}
	}

	// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
	document.addEventListener('DOMContentLoaded', function () {
		// –î–æ–±–∞–≤–ª—è–µ–º –∞–Ω–∏–º–∞—Ü–∏–∏ –¥–ª—è –∫–∞—Ä—Ç–æ—á–µ–∫
		const cards = document.querySelectorAll('.stats-card')
		cards.forEach((card, index) => {
			card.style.animationDelay = `${index * 0.1}s`
			card.classList.add('animate__animated', 'animate__fadeInUp')
		})

		// –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –∫–∞–∂–¥—É—é —Å–µ–∫—É–Ω–¥—É
		setInterval(() => {
			const now = new Date()
			const timeString = now.toLocaleString('ru-RU')
			// –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –≤ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–µ
		}, 1000)
	})

	// –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
	window.addEventListener('error', function (e) {
		console.error('JavaScript –æ—à–∏–±–∫–∞:', e.error)
	})
</script>
{% endblock %}
