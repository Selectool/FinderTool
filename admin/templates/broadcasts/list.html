{% extends "base.html" %} {% block title %}–ú–∞—Å—Å–æ–≤—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏{% endblock %} {%
block extra_head %}
<style>
	.broadcast-status {
		padding: 4px 8px;
		border-radius: 4px;
		font-size: 0.875rem;
		font-weight: 500;
	}
	.status-pending {
		background-color: #fef3c7;
		color: #92400e;
	}
	.status-sending {
		background-color: #dbeafe;
		color: #1e40af;
	}
	.status-completed {
		background-color: #d1fae5;
		color: #065f46;
	}
	.status-failed {
		background-color: #fee2e2;
		color: #991b1b;
	}
	.status-paused {
		background-color: #f3e8ff;
		color: #7c3aed;
	}

	.progress-bar-container {
		height: 8px;
		background-color: #e5e7eb;
		border-radius: 4px;
		overflow: hidden;
	}
	.progress-bar {
		height: 100%;
		background-color: #10b981;
		transition: width 0.3s ease;
	}
</style>
{% endblock %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
	<h1>üì¢ –ú–∞—Å—Å–æ–≤—ã–µ —Ä–∞—Å—Å—ã–ª–∫–∏</h1>
	<div>
		<a href="/broadcasts/templates" class="btn btn-outline-primary me-2">
			üìù –®–∞–±–ª–æ–Ω—ã
		</a>
		<a href="/broadcasts/create" class="btn btn-primary">
			‚ûï –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
		</a>
	</div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="card mb-4">
	<div class="card-body">
		<div class="row g-3">
			<div class="col-md-3">
				<label class="form-label">–°—Ç–∞—Ç—É—Å</label>
				<select class="form-select" id="statusFilter">
					<option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
					<option value="pending">–û–∂–∏–¥–∞–µ—Ç</option>
					<option value="sending">–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è</option>
					<option value="completed">–ó–∞–≤–µ—Ä—à–µ–Ω–∞</option>
					<option value="failed">–û—à–∏–±–∫–∞</option>
					<option value="paused">–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞</option>
				</select>
			</div>
			<div class="col-md-3">
				<label class="form-label">–ü–µ—Ä–∏–æ–¥</label>
				<select class="form-select" id="periodFilter">
					<option value="">–í—Å–µ –≤—Ä–µ–º—è</option>
					<option value="today">–°–µ–≥–æ–¥–Ω—è</option>
					<option value="week">–ù–µ–¥–µ–ª—è</option>
					<option value="month">–ú–µ—Å—è—Ü</option>
				</select>
			</div>
			<div class="col-md-4">
				<label class="form-label">–ü–æ–∏—Å–∫</label>
				<input
					type="text"
					class="form-control"
					id="searchFilter"
					placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ —Ç–µ–∫—Å—Ç—É..."
				/>
			</div>
			<div class="col-md-2">
				<label class="form-label">&nbsp;</label>
				<button
					class="btn btn-outline-secondary w-100"
					onclick="clearFilters()"
				>
					üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
				</button>
			</div>
		</div>
	</div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mb-4">
	<div class="col-md-3">
		<div class="card text-center">
			<div class="card-body">
				<h5 class="card-title text-primary">
					{{ broadcasts_stats.total or 0 }}
				</h5>
				<p class="card-text">–í—Å–µ–≥–æ —Ä–∞—Å—Å—ã–ª–æ–∫</p>
			</div>
		</div>
	</div>
	<div class="col-md-3">
		<div class="card text-center">
			<div class="card-body">
				<h5 class="card-title text-success">
					{{ broadcasts_stats.completed or 0 }}
				</h5>
				<p class="card-text">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</p>
			</div>
		</div>
	</div>
	<div class="col-md-3">
		<div class="card text-center">
			<div class="card-body">
				<h5 class="card-title text-info">
					{{ broadcasts_stats.sending or 0 }}
				</h5>
				<p class="card-text">–í –ø—Ä–æ—Ü–µ—Å—Å–µ</p>
			</div>
		</div>
	</div>
	<div class="col-md-3">
		<div class="card text-center">
			<div class="card-body">
				<h5 class="card-title text-warning">
					{{ broadcasts_stats.pending or 0 }}
				</h5>
				<p class="card-text">–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ</p>
			</div>
		</div>
	</div>
</div>

<!-- –°–ø–∏—Å–æ–∫ —Ä–∞—Å—Å—ã–ª–æ–∫ -->
<div class="card">
	<div class="card-body">
		{% if broadcasts %}
		<div class="table-responsive">
			<table class="table table-hover">
				<thead>
					<tr>
						<th>ID</th>
						<th>–ù–∞–∑–≤–∞–Ω–∏–µ/–¢–µ–∫—Å—Ç</th>
						<th>–°—Ç–∞—Ç—É—Å</th>
						<th>–ü—Ä–æ–≥—Ä–µ—Å—Å</th>
						<th>–¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è</th>
						<th>–°–æ–∑–¥–∞–Ω–æ</th>
						<th>–î–µ–π—Å—Ç–≤–∏—è</th>
					</tr>
				</thead>
				<tbody id="broadcastsTable">
					{% for broadcast in broadcasts %}
					<tr
						data-broadcast-id="{{ broadcast.id if broadcast.id else broadcast['id'] }}"
					>
						<td>
							<strong
								>#{{ broadcast.id if broadcast.id else broadcast['id']
								}}</strong
							>
						</td>
						<td>
							<div class="broadcast-preview">
								{% if broadcast.title or broadcast['title'] %}
								<strong
									>{{ broadcast.title if broadcast.title else broadcast['title']
									}}</strong
								><br />
								{% endif %}
								<small class="text-muted">
									{% set msg_text = broadcast.message_text if
									broadcast.message_text else broadcast['message_text'] %} {{
									msg_text[:100] if msg_text else '–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞' }}{% if msg_text
									and msg_text|length > 100 %}...{% endif %}
								</small>
							</div>
						</td>
						<td>
							<span
								class="broadcast-status status-{{ broadcast.status or 'pending' }}"
							>
								{% set status = broadcast.status if broadcast.status else
								broadcast['status'] %} {% if status == 'pending' %}‚è≥ –û–∂–∏–¥–∞–µ—Ç {%
								elif status == 'sending' %}üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è {% elif status ==
								'completed' %}‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∞ {% elif status == 'failed' %}‚ùå
								–û—à–∏–±–∫–∞ {% elif status == 'paused' %}‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ {% else
								%}‚è≥ –û–∂–∏–¥–∞–µ—Ç {% endif %}
							</span>
						</td>
						<td>
							<div class="progress-info">
								{% set sent_count = broadcast.sent_count if broadcast.sent_count
								else (broadcast['sent_count'] or 0) %} {% set failed_count =
								broadcast.failed_count if broadcast.failed_count else
								(broadcast['failed_count'] or 0) %} {% set total = sent_count +
								failed_count %} {% set sent = sent_count %} {% if total > 0 %}
								{% set progress = (sent / total * 100)|round(1) %}
								<div class="progress-bar-container mb-1">
									<div
										class="progress-bar"
										style="width: {{ progress }}%"
									></div>
								</div>
								<small class="text-muted"
									>{{ sent }}/{{ total }} ({{ progress }}%)</small
								>
								{% else %}
								<small class="text-muted">–ù–µ –∑–∞–ø—É—â–µ–Ω–∞</small>
								{% endif %}
							</div>
						</td>
						<td>
							<small class="text-muted">
								{% set target = broadcast.target_users if broadcast.target_users
								else broadcast['target_users'] %} {% if target == 'all' %}üë• –í—Å–µ
								–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ {% elif target == 'subscribers' %}üíé –ü–æ–¥–ø–∏—Å—á–∏–∫–∏ {%
								elif target == 'active' %}üü¢ –ê–∫—Ç–∏–≤–Ω—ã–µ {% else %}üéØ –í—ã–±–æ—Ä–æ—á–Ω–æ {%
								endif %}
							</small>
						</td>
						<td>
							<small class="text-muted">
								{% set created = broadcast.created_at if broadcast.created_at
								else broadcast['created_at'] %} {% if created %} {% if created
								is string %} {{ created[:19].replace('T', ' ') if 'T' in created
								else created[:19] }} {% else %} {{ created.strftime('%d.%m.%Y
								%H:%M') }} {% endif %} {% else %} - {% endif %}
							</small>
						</td>
						<td>
							<div class="btn-group btn-group-sm">
								<a
									href="/broadcasts/{{ broadcast.id if broadcast.id else broadcast['id'] }}"
									class="btn btn-outline-primary"
									title="–ü—Ä–æ—Å–º–æ—Ç—Ä"
								>
									üëÅÔ∏è
								</a>
								{% set status = broadcast.status if broadcast.status else
								broadcast['status'] %} {% if status == 'pending' %}
								<button
									class="btn btn-outline-success"
									onclick="startBroadcast({{ broadcast.id if broadcast.id else broadcast['id'] }})"
									title="–ó–∞–ø—É—Å—Ç–∏—Ç—å"
								>
									‚ñ∂Ô∏è
								</button>
								{% elif broadcast.status == 'sending' %}
								<button
									class="btn btn-outline-warning"
									onclick="pauseBroadcast({{ broadcast.id }})"
									title="–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å"
								>
									‚è∏Ô∏è
								</button>
								{% elif broadcast.status == 'paused' %}
								<button
									class="btn btn-outline-success"
									onclick="resumeBroadcast({{ broadcast.id }})"
									title="–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å"
								>
									‚ñ∂Ô∏è
								</button>
								{% endif %} {% if broadcast.status in ['pending', 'failed'] %}
								<button
									class="btn btn-outline-danger"
									onclick="deleteBroadcast({{ broadcast.id }})"
									title="–£–¥–∞–ª–∏—Ç—å"
								>
									üóëÔ∏è
								</button>
								{% endif %}
							</div>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>

		<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
		{% if pagination and pagination.pages > 1 %}
		<nav aria-label="–ü–∞–≥–∏–Ω–∞—Ü–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫">
			<ul class="pagination justify-content-center">
				{% if pagination.has_prev %}
				<li class="page-item">
					<a class="page-link" href="?page={{ pagination.prev_num }}"
						>–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a
					>
				</li>
				{% endif %} {% for page_num in pagination.iter_pages() %} {% if page_num
				%} {% if page_num != pagination.page %}
				<li class="page-item">
					<a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
				</li>
				{% else %}
				<li class="page-item active">
					<span class="page-link">{{ page_num }}</span>
				</li>
				{% endif %} {% else %}
				<li class="page-item disabled">
					<span class="page-link">‚Ä¶</span>
				</li>
				{% endif %} {% endfor %} {% if pagination.has_next %}
				<li class="page-item">
					<a class="page-link" href="?page={{ pagination.next_num }}"
						>–°–ª–µ–¥—É—é—â–∞—è</a
					>
				</li>
				{% endif %}
			</ul>
		</nav>
		{% endif %} {% else %}
		<div class="text-center py-5">
			<div class="mb-3">
				<i class="fas fa-bullhorn fa-3x text-muted"></i>
			</div>
			<h5 class="text-muted">–†–∞—Å—Å—ã–ª–æ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</h5>
			<p class="text-muted">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—É—é —Ä–∞—Å—Å—ã–ª–∫—É –¥–ª—è –≤–∞—à–∏—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
			<a href="/broadcasts/create" class="btn btn-primary">
				‚ûï –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
			</a>
		</div>
		{% endif %}
	</div>
</div>
{% endblock %} {% block extra_scripts %}
<script>
	// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∞–º–∏
	async function startBroadcast(broadcastId) {
		if (!confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return

		try {
			const response = await fetch(`/api/broadcasts/${broadcastId}/start`, {
				method: 'POST',
			})

			if (response.ok) {
				location.reload()
			} else {
				alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏')
			}
		} catch (error) {
			console.error('–û—à–∏–±–∫–∞:', error)
			alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏')
		}
	}

	async function pauseBroadcast(broadcastId) {
		if (!confirm('–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É?')) return

		try {
			const response = await fetch(`/api/broadcasts/${broadcastId}/pause`, {
				method: 'POST',
			})

			if (response.ok) {
				location.reload()
			} else {
				alert('–û—à–∏–±–∫–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏')
			}
		} catch (error) {
			console.error('–û—à–∏–±–∫–∞:', error)
			alert('–û—à–∏–±–∫–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏')
		}
	}

	async function resumeBroadcast(broadcastId) {
		if (!confirm('–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É?')) return

		try {
			const response = await fetch(`/api/broadcasts/${broadcastId}/resume`, {
				method: 'POST',
			})

			if (response.ok) {
				location.reload()
			} else {
				alert('–û—à–∏–±–∫–∞ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏')
			}
		} catch (error) {
			console.error('–û—à–∏–±–∫–∞:', error)
			alert('–û—à–∏–±–∫–∞ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏')
		}
	}

	async function deleteBroadcast(broadcastId) {
		if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return

		try {
			const response = await fetch(`/api/broadcasts/${broadcastId}`, {
				method: 'DELETE',
			})

			if (response.ok) {
				location.reload()
			} else {
				alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏')
			}
		} catch (error) {
			console.error('–û—à–∏–±–∫–∞:', error)
			alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏')
		}
	}

	// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è
	function clearFilters() {
		document.getElementById('statusFilter').value = ''
		document.getElementById('periodFilter').value = ''
		document.getElementById('searchFilter').value = ''
		filterBroadcasts()
	}

	function filterBroadcasts() {
		// TODO: –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∫–ª–∏–µ–Ω—Ç—Å–∫—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –∏–ª–∏ AJAX –∑–∞–ø—Ä–æ—Å—ã
	}

	// –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫
	setInterval(async () => {
		const sendingRows = document.querySelectorAll('tr[data-broadcast-id]')
		for (const row of sendingRows) {
			const status = row.querySelector('.broadcast-status')
			if (status && status.textContent.includes('–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è')) {
				// –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫
				const broadcastId = row.dataset.broadcastId
				try {
					const response = await fetch(`/api/broadcasts/${broadcastId}/status`)
					if (response.ok) {
						const data = await response.json()
						// –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
						updateBroadcastProgress(row, data)
					}
				} catch (error) {
					console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞:', error)
				}
			}
		}
	}, 5000) // –û–±–Ω–æ–≤–ª—è–µ–º –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥

	function updateBroadcastProgress(row, data) {
		const progressBar = row.querySelector('.progress-bar')
		const progressText = row.querySelector('.progress-info small')
		const statusSpan = row.querySelector('.broadcast-status')

		if (progressBar && data.total > 0) {
			const progress = (data.sent / data.total) * 100
			progressBar.style.width = progress + '%'
			progressText.textContent = `${data.sent}/${
				data.total
			} (${progress.toFixed(1)}%)`
		}

		if (statusSpan && data.status !== statusSpan.dataset.status) {
			// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è
			location.reload()
		}
	}
</script>
{% endblock %}
