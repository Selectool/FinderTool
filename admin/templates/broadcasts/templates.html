{% extends "base.html" %}

{% block title %}–®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π{% endblock %}

{% block extra_head %}
<style>
.template-card {
    transition: all 0.2s;
    cursor: pointer;
}

.template-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.template-preview {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 12px;
    font-size: 0.9rem;
    max-height: 100px;
    overflow: hidden;
    position: relative;
}

.template-preview::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 20px;
    background: linear-gradient(transparent, #f8f9fa);
}

.category-badge {
    font-size: 0.75rem;
    padding: 4px 8px;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>üìù –®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π</h1>
    <div>
        <a href="/broadcasts/" class="btn btn-outline-secondary me-2">
            ‚Üê –ö —Ä–∞—Å—Å—ã–ª–∫–∞–º
        </a>
        <a href="/broadcasts/templates/create" class="btn btn-primary">
            ‚ûï –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω
        </a>
    </div>
</div>

<!-- –§–∏–ª—å—Ç—Ä—ã -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-3">
                <label class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                <select class="form-select" id="categoryFilter">
                    <option value="">–í—Å–µ –∫–∞—Ç–µ–≥–æ—Ä–∏–∏</option>
                    <option value="general">–û–±—â–∏–µ</option>
                    <option value="promotion">–ê–∫—Ü–∏–∏</option>
                    <option value="notification">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</option>
                    <option value="welcome">–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ</option>
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">–ü–æ–∏—Å–∫</label>
                <input type="text" class="form-control" id="searchFilter" placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ —Å–æ–¥–µ—Ä–∂–∏–º–æ–º—É...">
            </div>
            <div class="col-md-3">
                <label class="form-label">&nbsp;</label>
                <button class="btn btn-outline-secondary w-100" onclick="clearFilters()">
                    üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å
                </button>
            </div>
        </div>
    </div>
</div>

<!-- –®–∞–±–ª–æ–Ω—ã -->
{% if templates %}
<div class="row" id="templatesGrid">
    {% for template in templates %}
    <div class="col-lg-4 col-md-6 mb-4 template-item" data-category="{{ template.category }}" data-name="{{ template.name|lower }}" data-content="{{ template.content|lower }}">
        <div class="card template-card h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h5 class="card-title mb-0">{{ template.name }}</h5>
                    <span class="badge bg-secondary category-badge">{{ template.category }}</span>
                </div>
                
                <div class="template-preview mb-3">
                    {{ template.content|safe }}
                </div>
                
                <div class="d-flex justify-content-between align-items-center">
                    <small class="text-muted">
                        –°–æ–∑–¥–∞–Ω: {{ template.created_at.strftime('%d.%m.%Y') if template.created_at else '-' }}
                    </small>
                    
                    <div class="btn-group btn-group-sm">
                        <button class="btn btn-outline-primary" onclick="useTemplate({{ template.id }})" title="–ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å">
                            üìã
                        </button>
                        <button class="btn btn-outline-secondary" onclick="editTemplate({{ template.id }})" title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn btn-outline-danger" onclick="deleteTemplate({{ template.id }})" title="–£–¥–∞–ª–∏—Ç—å">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endfor %}
</div>

<!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
{% if pagination and pagination.pages > 1 %}
<nav aria-label="–ü–∞–≥–∏–Ω–∞—Ü–∏—è —à–∞–±–ª–æ–Ω–æ–≤">
    <ul class="pagination justify-content-center">
        {% if pagination.has_prev %}
        <li class="page-item">
            <a class="page-link" href="?page={{ pagination.prev_num }}">–ü—Ä–µ–¥—ã–¥—É—â–∞—è</a>
        </li>
        {% endif %}
        
        {% for page_num in pagination.iter_pages() %}
            {% if page_num %}
                {% if page_num != pagination.page %}
                <li class="page-item">
                    <a class="page-link" href="?page={{ page_num }}">{{ page_num }}</a>
                </li>
                {% else %}
                <li class="page-item active">
                    <span class="page-link">{{ page_num }}</span>
                </li>
                {% endif %}
            {% else %}
            <li class="page-item disabled">
                <span class="page-link">‚Ä¶</span>
            </li>
            {% endif %}
        {% endfor %}
        
        {% if pagination.has_next %}
        <li class="page-item">
            <a class="page-link" href="?page={{ pagination.next_num }}">–°–ª–µ–¥—É—é—â–∞—è</a>
        </li>
        {% endif %}
    </ul>
</nav>
{% endif %}

{% else %}
<div class="text-center py-5">
    <div class="mb-3">
        <i class="fas fa-file-alt fa-3x text-muted"></i>
    </div>
    <h5 class="text-muted">–®–∞–±–ª–æ–Ω–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</h5>
    <p class="text-muted">–°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤—ã–π —à–∞–±–ª–æ–Ω –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—Å—ã–ª–æ–∫</p>
    <a href="/broadcasts/templates/create" class="btn btn-primary">
        ‚ûï –°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω
    </a>
</div>
{% endif %}

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
<div class="modal fade" id="previewModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üëÅÔ∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —à–∞–±–ª–æ–Ω–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="templatePreviewContent">
                    <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —à–∞–±–ª–æ–Ω–∞ -->
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    –ó–∞–∫—Ä—ã—Ç—å
                </button>
                <button type="button" class="btn btn-primary" id="useTemplateBtn">
                    üìã –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
// –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —à–∞–±–ª–æ–Ω–æ–≤
function filterTemplates() {
    const categoryFilter = document.getElementById('categoryFilter').value.toLowerCase();
    const searchFilter = document.getElementById('searchFilter').value.toLowerCase();
    const templateItems = document.querySelectorAll('.template-item');
    
    templateItems.forEach(item => {
        const category = item.dataset.category.toLowerCase();
        const name = item.dataset.name;
        const content = item.dataset.content;
        
        const categoryMatch = !categoryFilter || category === categoryFilter;
        const searchMatch = !searchFilter || 
            name.includes(searchFilter) || 
            content.includes(searchFilter);
        
        if (categoryMatch && searchMatch) {
            item.style.display = 'block';
        } else {
            item.style.display = 'none';
        }
    });
}

function clearFilters() {
    document.getElementById('categoryFilter').value = '';
    document.getElementById('searchFilter').value = '';
    filterTemplates();
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–æ–≤
document.getElementById('categoryFilter').addEventListener('change', filterTemplates);
document.getElementById('searchFilter').addEventListener('input', filterTemplates);

// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞–º–∏
function useTemplate(templateId) {
    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏ —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º —à–∞–±–ª–æ–Ω–æ–º
    window.location.href = `/broadcasts/create?template=${templateId}`;
}

function editTemplate(templateId) {
    // –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞
    window.location.href = `/broadcasts/templates/${templateId}/edit`;
}

async function deleteTemplate(templateId) {
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
    
    try {
        const response = await fetch(`/api/templates/${templateId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            location.reload();
        } else {
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞');
    }
}

// –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —à–∞–±–ª–æ–Ω–∞
function previewTemplate(templateId, templateName, templateContent) {
    document.getElementById('templatePreviewContent').innerHTML = templateContent;
    document.querySelector('#previewModal .modal-title').textContent = `üëÅÔ∏è ${templateName}`;
    
    const useBtn = document.getElementById('useTemplateBtn');
    useBtn.onclick = () => useTemplate(templateId);
    
    new bootstrap.Modal(document.getElementById('previewModal')).show();
}

// –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ –∫–∞—Ä—Ç–æ—á–∫–∏ —à–∞–±–ª–æ–Ω–æ–≤ –¥–ª—è –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
document.addEventListener('DOMContentLoaded', function() {
    const templateCards = document.querySelectorAll('.template-card');
    
    templateCards.forEach(card => {
        card.addEventListener('click', function(e) {
            // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –∫–ª–∏–∫–∏ –Ω–∞ –∫–Ω–æ–ø–∫–∏
            if (e.target.closest('.btn-group')) return;
            
            const templateItem = this.closest('.template-item');
            const templateId = templateItem.querySelector('[onclick*="useTemplate"]').onclick.toString().match(/\d+/)[0];
            const templateName = templateItem.querySelector('.card-title').textContent;
            const templateContent = templateItem.querySelector('.template-preview').innerHTML;
            
            previewTemplate(templateId, templateName, templateContent);
        });
    });
});

// –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
document.addEventListener('keydown', function(e) {
    // Ctrl+N - —Å–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —à–∞–±–ª–æ–Ω
    if (e.ctrlKey && e.key === 'n') {
        e.preventDefault();
        window.location.href = '/broadcasts/templates/create';
    }
    
    // Escape - –æ—á–∏—Å—Ç–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
    if (e.key === 'Escape') {
        clearFilters();
    }
});
</script>
{% endblock %}
