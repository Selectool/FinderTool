{% extends "base.html" %} {% block title %}–°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏{% endblock %} {%
block extra_head %}
<!-- Quill Rich Text Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet" />
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<!-- Flatpickr –¥–ª—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ -->
<link
	rel="stylesheet"
	href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css"
/>
<script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
<script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ru.js"></script>

<style>
	.preview-panel {
		border: 1px solid #dee2e6;
		border-radius: 0.375rem;
		padding: 1rem;
		background-color: #f8f9fa;
		min-height: 200px;
	}

	.telegram-message {
		background: white;
		border-radius: 12px;
		padding: 12px 16px;
		max-width: 400px;
		box-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
		font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
			sans-serif;
		font-size: 14px;
		line-height: 1.4;
	}

	.audience-stats {
		background: #e3f2fd;
		border-radius: 8px;
		padding: 12px;
		margin-top: 8px;
	}

	.template-item {
		cursor: pointer;
		transition: all 0.2s;
	}

	.template-item:hover {
		background-color: #f8f9fa;
		border-color: #0d6efd !important;
	}

	.template-item.selected {
		background-color: #e7f3ff;
		border-color: #0d6efd !important;
	}

	#editor {
		height: 200px;
	}

	.media-upload-area {
		border: 2px dashed #dee2e6;
		border-radius: 8px;
		padding: 2rem;
		text-align: center;
		transition: all 0.2s;
	}

	.media-upload-area:hover {
		border-color: #0d6efd;
		background-color: #f8f9fa;
	}

	.media-upload-area.dragover {
		border-color: #0d6efd;
		background-color: #e7f3ff;
	}
</style>
{% endblock %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
	<h1>üì¢ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏</h1>
	<a href="/broadcasts/" class="btn btn-outline-secondary">
		‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
	</a>
</div>

<form id="broadcastForm" enctype="multipart/form-data">
	<div class="row">
		<!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
		<div class="col-lg-8">
			<!-- –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
			<div class="card mb-4">
				<div class="card-header">
					<h5 class="mb-0">üìù –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
				</div>
				<div class="card-body">
					<div class="mb-3">
						<label for="broadcastName" class="form-label"
							>–ù–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏</label
						>
						<input
							type="text"
							class="form-control"
							id="broadcastName"
							name="name"
							placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ù–æ–≤–æ–≥–æ–¥–Ω—è—è –∞–∫—Ü–∏—è 2025"
							required
						/>
						<div class="form-text">–ù–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è –≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è</div>
					</div>

					<div class="mb-3">
						<label for="messageType" class="form-label">–¢–∏–ø —Å–æ–æ–±—â–µ–Ω–∏—è</label>
						<select class="form-select" id="messageType" name="message_type">
							<option value="text">üìù –¢–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç</option>
							<option value="photo">üñºÔ∏è –¢–µ–∫—Å—Ç —Å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ–º</option>
							<option value="document">üìé –¢–µ–∫—Å—Ç —Å –¥–æ–∫—É–º–µ–Ω—Ç–æ–º</option>
						</select>
					</div>

					<!-- –ú–µ–¥–∏–∞ —Ñ–∞–π–ª—ã -->
					<div id="mediaSection" style="display: none">
						<div class="mb-3">
							<label class="form-label">–ú–µ–¥–∏–∞ —Ñ–∞–π–ª</label>
							<div class="media-upload-area" id="mediaUploadArea">
								<div class="upload-content">
									<i class="fas fa-cloud-upload-alt fa-2x text-muted mb-2"></i>
									<p class="mb-2">
										–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª —Å—é–¥–∞ –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞
									</p>
									<small class="text-muted">
										–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: JPG, PNG –¥–æ 10MB<br />
										–î–æ–∫—É–º–µ–Ω—Ç—ã: PDF, DOC, DOCX –¥–æ 50MB
									</small>
								</div>
								<input
									type="file"
									id="mediaFile"
									name="media_file"
									accept="image/*,.pdf,.doc,.docx"
									style="display: none"
								/>
							</div>
							<div id="mediaPreview" style="display: none"></div>
						</div>
					</div>
				</div>
			</div>

			<!-- –®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π -->
			<div class="card mb-4">
				<div
					class="card-header d-flex justify-content-between align-items-center"
				>
					<h5 class="mb-0">üìã –®–∞–±–ª–æ–Ω—ã —Å–æ–æ–±—â–µ–Ω–∏–π</h5>
					<button
						type="button"
						class="btn btn-sm btn-outline-primary"
						onclick="toggleTemplates()"
					>
						<span id="templatesToggleText">–ü–æ–∫–∞–∑–∞—Ç—å —à–∞–±–ª–æ–Ω—ã</span>
					</button>
				</div>
				<div class="card-body" id="templatesSection" style="display: none">
					<div class="row" id="templatesList">
						{% for template in templates %}
						<div class="col-md-6 mb-3">
							<div
								class="card template-item"
								data-template-id="{{ template.id }}"
								onclick="selectTemplate({{ template.id }}, '{{ template.content|e }}')"
							>
								<div class="card-body">
									<h6 class="card-title">{{ template.name }}</h6>
									<p class="card-text text-muted small">
										{{ template.content[:100] }}{% if template.content|length >
										100 %}...{% endif %}
									</p>
									<small class="text-muted">{{ template.category }}</small>
								</div>
							</div>
						</div>
						{% endfor %}
					</div>
					{% if not templates %}
					<div class="text-center text-muted">
						<p>–®–∞–±–ª–æ–Ω–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</p>
						<a
							href="/broadcasts/templates/create"
							class="btn btn-sm btn-outline-primary"
						>
							–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω
						</a>
					</div>
					{% endif %}
				</div>
			</div>

			<!-- –†–µ–¥–∞–∫—Ç–æ—Ä —Å–æ–æ–±—â–µ–Ω–∏—è -->
			<div class="card mb-4">
				<div class="card-header">
					<h5 class="mb-0">‚úèÔ∏è –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è</h5>
				</div>
				<div class="card-body">
					<div class="mb-3">
						<textarea
							class="form-control"
							id="messageTextArea"
							name="message_text"
							rows="8"
							placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è..."
							required
							maxlength="4096"
						></textarea>
						<input type="hidden" id="messageText" name="message_text_html" />
					</div>

					<div class="row mb-3">
						<div class="col-md-6">
							<div class="form-check">
								<input
									class="form-check-input"
									type="checkbox"
									id="enableMarkdown"
									checked
								/>
								<label class="form-check-label" for="enableMarkdown">
									–í–∫–ª—é—á–∏—Ç—å —Ä–∞–∑–º–µ—Ç–∫—É Telegram
								</label>
							</div>
						</div>
						<div class="col-md-6 text-end">
							<button
								type="button"
								class="btn btn-sm btn-outline-info"
								onclick="showMarkdownHelp()"
							>
								‚ùì –°–ø—Ä–∞–≤–∫–∞ –ø–æ —Ä–∞–∑–º–µ—Ç–∫–µ
							</button>
						</div>
					</div>

					<div class="mt-3">
						<small class="text-muted">
							üí° –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: <strong>*–∂–∏—Ä–Ω—ã–π*</strong>, <em>_–∫—É—Ä—Å–∏–≤_</em>,
							<code>`–º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π`</code>, [—Å—Å—ã–ª–∫–∏](url) –∏ —ç–º–æ–¥–∑–∏
						</small>
					</div>

					<div class="mt-2">
						<span class="badge bg-secondary" id="charCount">0 —Å–∏–º–≤–æ–ª–æ–≤</span>
						<span
							class="badge bg-warning"
							id="charWarning"
							style="display: none"
						>
							–ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç Telegram (4096 —Å–∏–º–≤–æ–ª–æ–≤)
						</span>
						<span class="badge bg-danger" id="charError" style="display: none">
							–ö—Ä–∏—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–µ –ª–∏–º–∏—Ç–∞!
						</span>
					</div>
				</div>
			</div>

			<!-- –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ -->
			<div class="card mb-4">
				<div class="card-header">
					<h5 class="mb-0">‚è∞ –ü–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏</h5>
				</div>
				<div class="card-body">
					<div class="form-check mb-3">
						<input
							class="form-check-input"
							type="radio"
							name="schedule_type"
							id="sendNow"
							value="now"
							checked
						/>
						<label class="form-check-label" for="sendNow">
							üöÄ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–µ–π—á–∞—Å
						</label>
					</div>

					<div class="form-check mb-3">
						<input
							class="form-check-input"
							type="radio"
							name="schedule_type"
							id="sendLater"
							value="later"
						/>
						<label class="form-check-label" for="sendLater">
							üìÖ –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è
						</label>
					</div>

					<div id="scheduleDateTime" style="display: none">
						<div class="row">
							<div class="col-md-6">
								<label for="scheduleDate" class="form-label">–î–∞—Ç–∞</label>
								<input
									type="text"
									class="form-control"
									id="scheduleDate"
									name="schedule_date"
									placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É"
								/>
							</div>
							<div class="col-md-6">
								<label for="scheduleTime" class="form-label">–í—Ä–µ–º—è</label>
								<input
									type="text"
									class="form-control"
									id="scheduleTime"
									name="schedule_time"
									placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –≤—Ä–µ–º—è"
								/>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
		<div class="col-lg-4">
			<!-- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä -->
			<div class="card mb-4">
				<div class="card-header">
					<h5 class="mb-0">üëÅÔ∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</h5>
				</div>
				<div class="card-body">
					<div class="preview-panel">
						<div class="telegram-message" id="messagePreview">
							<em class="text-muted">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è...</em>
						</div>
					</div>
				</div>
			</div>

			<!-- –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è -->
			<div class="card mb-4">
				<div
					class="card-header d-flex justify-content-between align-items-center"
				>
					<h5 class="mb-0">üéØ –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è</h5>
					<button
						type="button"
						class="btn btn-sm btn-outline-primary"
						onclick="refreshAudienceStats()"
					>
						üîÑ –û–±–Ω–æ–≤–∏—Ç—å
					</button>
				</div>
				<div class="card-body">
					<div class="form-check mb-2">
						<input
							class="form-check-input"
							type="radio"
							name="target_audience"
							id="targetAll"
							value="all"
						/>
						<label class="form-check-label" for="targetAll">
							üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏
							<small class="text-muted d-block"
								>–í–∫–ª—é—á–∞—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö</small
							>
						</label>
					</div>

					<div class="form-check mb-2">
						<input
							class="form-check-input"
							type="radio"
							name="target_audience"
							id="targetActive"
							value="active"
							checked
						/>
						<label class="form-check-label" for="targetActive">
							üü¢ –¢–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ
							<small class="text-muted d-block"
								>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏, –∞–∫—Ç–∏–≤–Ω—ã–µ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 30 –¥–Ω–µ–π</small
							>
						</label>
					</div>

					<div class="form-check mb-2">
						<input
							class="form-check-input"
							type="radio"
							name="target_audience"
							id="targetSubscribers"
							value="subscribers"
						/>
						<label class="form-check-label" for="targetSubscribers">
							üíé –¢–æ–ª—å–∫–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–∏
							<small class="text-muted d-block"
								>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –∞–∫—Ç–∏–≤–Ω–æ–π –ø–æ–¥–ø–∏—Å–∫–æ–π</small
							>
						</label>
					</div>

					<div class="form-check mb-3">
						<input
							class="form-check-input"
							type="radio"
							name="target_audience"
							id="targetCustom"
							value="custom"
						/>
						<label class="form-check-label" for="targetCustom">
							üéØ –í—ã–±–æ—Ä–æ—á–Ω–æ
							<small class="text-muted d-block"
								>–£–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</small
							>
						</label>
					</div>

					<!-- –ö–∞—Å—Ç–æ–º–Ω–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è -->
					<div id="customAudienceSection" style="display: none">
						<div class="mb-3">
							<label for="customUserIds" class="form-label">
								ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é)
							</label>
							<textarea
								class="form-control"
								id="customUserIds"
								name="custom_user_ids"
								rows="3"
								placeholder="123456789, 987654321, ..."
							></textarea>
							<div class="form-text">
								–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π Telegram —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é
							</div>
						</div>
						<button
							type="button"
							class="btn btn-sm btn-outline-secondary"
							onclick="validateCustomUsers()"
						>
							‚úÖ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
						</button>
					</div>

					<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∞—É–¥–∏—Ç–æ—Ä–∏–∏ -->
					<div class="row mt-3">
						<div class="col-md-6">
							<div class="alert alert-primary">
								<div class="d-flex justify-content-between align-items-center">
									<strong>–ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π:</strong>
									<span id="recipientCount" class="badge bg-primary fs-6">
										<span
											class="spinner-border spinner-border-sm"
											role="status"
										></span>
									</span>
								</div>
								<div class="mt-2">
									<small class="text-muted">
										–ü—Ä–∏–º–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏: <span id="estimatedTime">-</span>
									</small>
								</div>
							</div>
						</div>
						<div class="col-md-6">
							<div class="alert alert-info">
								<strong>–î–µ—Ç–∞–ª–∏ –∞—É–¥–∏—Ç–æ—Ä–∏–∏:</strong>
								<ul class="mb-0 mt-2" id="audienceDetails">
									<li>–ó–∞–≥—Ä—É–∑–∫–∞...</li>
								</ul>
							</div>
						</div>
					</div>

					<!-- –ö–Ω–æ–ø–∫–∞ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π -->
					<button
						type="button"
						class="btn btn-outline-info btn-sm"
						onclick="previewRecipients()"
					>
						üëÅÔ∏è –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–ø–∏—Å–∫–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
					</button>
				</div>
			</div>

			<!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
			<div class="card mb-4">
				<div class="card-header">
					<h5 class="mb-0">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏</h5>
				</div>
				<div class="card-body">
					<div class="mb-3">
						<label for="sendRate" class="form-label">–°–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏</label>
						<select class="form-select" id="sendRate" name="send_rate">
							<option value="slow">üêå –ú–µ–¥–ª–µ–Ω–Ω–æ (10 —Å–æ–æ–±—â–µ–Ω–∏–π/–º–∏–Ω)</option>
							<option value="normal" selected>
								‚ö° –û–±—ã—á–Ω–æ (30 —Å–æ–æ–±—â–µ–Ω–∏–π/–º–∏–Ω)
							</option>
							<option value="fast">üöÄ –ë—ã—Å—Ç—Ä–æ (60 —Å–æ–æ–±—â–µ–Ω–∏–π/–º–∏–Ω)</option>
						</select>
						<div class="form-text">
							–ú–µ–¥–ª–µ–Ω–Ω–∞—è —Å–∫–æ—Ä–æ—Å—Ç—å —Å–Ω–∏–∂–∞–µ—Ç —Ä–∏—Å–∫ –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
						</div>
					</div>

					<div class="form-check mb-3">
						<input
							class="form-check-input"
							type="checkbox"
							id="skipBlocked"
							name="skip_blocked"
							checked
						/>
						<label class="form-check-label" for="skipBlocked">
							–ü—Ä–æ–ø—É—Å–∫–∞—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
						</label>
					</div>

					<div class="form-check mb-3">
						<input
							class="form-check-input"
							type="checkbox"
							id="saveAsTemplate"
							name="save_as_template"
						/>
						<label class="form-check-label" for="saveAsTemplate">
							–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —à–∞–±–ª–æ–Ω
						</label>
					</div>
				</div>
			</div>

			<!-- –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π -->
			<div class="card">
				<div class="card-body">
					<button
						type="button"
						class="btn btn-outline-primary w-100 mb-2"
						onclick="showPreview()"
					>
						üëÅÔ∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä
					</button>

					<button type="submit" class="btn btn-success w-100 mb-2">
						üì§ –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
					</button>

					<button
						type="button"
						class="btn btn-outline-secondary w-100"
						onclick="saveDraft()"
					>
						üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–∞–∫ —á–µ—Ä–Ω–æ–≤–∏–∫
					</button>
				</div>
			</div>
		</div>
	</div>
</form>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ -->
<div class="modal fade" id="previewModal" tabindex="-1">
	<div class="modal-dialog modal-lg">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title">üëÅÔ∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞—Å—Å—ã–ª–∫–∏</h5>
				<button
					type="button"
					class="btn-close"
					data-bs-dismiss="modal"
				></button>
			</div>
			<div class="modal-body">
				<div class="row">
					<div class="col-md-6">
						<h6>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞—Å—Å—ã–ª–∫–µ</h6>
						<table class="table table-sm">
							<tr>
								<td>–ù–∞–∑–≤–∞–Ω–∏–µ:</td>
								<td id="previewName">-</td>
							</tr>
							<tr>
								<td>–ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π:</td>
								<td id="previewRecipients">-</td>
							</tr>
							<tr>
								<td>–û—Ç–ø—Ä–∞–≤–∫–∞:</td>
								<td id="previewSchedule">-</td>
							</tr>
						</table>
					</div>
					<div class="col-md-6">
						<h6>–ö–∞–∫ —É–≤–∏–¥—è—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h6>
						<div class="telegram-message" id="previewMessage">
							<!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è -->
						</div>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
					–ó–∞–∫—Ä—ã—Ç—å
				</button>
				<button
					type="button"
					class="btn btn-success"
					onclick="submitBroadcast()"
				>
					üì§ –°–æ–∑–¥–∞—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É
				</button>
			</div>
		</div>
	</div>
</div>
{% endblock %} {% block extra_js %}
<script>
	// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
	let audienceData = {}
	let currentRecipients = []

	// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è onclick –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤
	async function refreshAudienceStats() {
		await updateAudienceStats()
	}

	function validateCustomUsers() {
		const customUserIds = document.getElementById('customUserIds').value
		const userIds = customUserIds
			.split(',')
			.map(id => id.trim())
			.filter(id => id)

		if (userIds.length === 0) {
			alert('–í–≤–µ–¥–∏—Ç–µ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è')
			return
		}

		// –ü—Ä–æ—Å—Ç–∞—è –≤–∞–ª–∏–¥–∞—Ü–∏—è ID (–¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —á–∏—Å–ª–∞–º–∏)
		const invalidIds = userIds.filter(id => !/^\d+$/.test(id))
		if (invalidIds.length > 0) {
			alert(`–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${invalidIds.join(', ')}`)
			return
		}

		alert(`–ü—Ä–æ–≤–µ—Ä–µ–Ω–æ ${userIds.length} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π. –í—Å–µ ID –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã.`)
	}

	function showMarkdownHelp() {
		const helpHtml = `
			<div class="modal fade" id="markdownHelpModal" tabindex="-1">
				<div class="modal-dialog">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">–°–ø—Ä–∞–≤–∫–∞ –ø–æ —Ä–∞–∑–º–µ—Ç–∫–µ Telegram</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
						</div>
						<div class="modal-body">
							<table class="table table-sm">
								<thead>
									<tr>
										<th>–†–∞–∑–º–µ—Ç–∫–∞</th>
										<th>–†–µ–∑—É–ª—å—Ç–∞—Ç</th>
									</tr>
								</thead>
								<tbody>
									<tr>
										<td><code>*–∂–∏—Ä–Ω—ã–π*</code></td>
										<td><strong>–∂–∏—Ä–Ω—ã–π</strong></td>
									</tr>
									<tr>
										<td><code>_–∫—É—Ä—Å–∏–≤_</code></td>
										<td><em>–∫—É—Ä—Å–∏–≤</em></td>
									</tr>
									<tr>
										<td><code>\`–º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π\`</code></td>
										<td><code>–º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π</code></td>
									</tr>
									<tr>
										<td><code>[—Å—Å—ã–ª–∫–∞](https://example.com)</code></td>
										<td><a href="#">—Å—Å—ã–ª–∫–∞</a></td>
									</tr>
								</tbody>
							</table>
							<div class="alert alert-info">
								<strong>–°–æ–≤–µ—Ç:</strong> –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —ç–º–æ–¥–∑–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –≤–æ—Å–ø—Ä–∏—è—Ç–∏—è —Å–æ–æ–±—â–µ–Ω–∏—è! üéâ
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
						</div>
					</div>
				</div>
			</div>
		`

		// –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –µ—Å–ª–∏ –µ—Å—Ç—å
		const existingModal = document.getElementById('markdownHelpModal')
		if (existingModal) {
			existingModal.remove()
		}

		// –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
		document.body.insertAdjacentHTML('beforeend', helpHtml)

		// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
		new bootstrap.Modal(document.getElementById('markdownHelpModal')).show()
	}

	function showPreview() {
		const messageText = document.getElementById('messageTextArea').value.trim()
		const broadcastName = document.getElementById('broadcastName').value.trim()
		const enableMarkdown = document.getElementById('enableMarkdown').checked
		const targetType = document.querySelector(
			'input[name="target_audience"]:checked'
		).value

		if (!messageText) {
			alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞')
			return
		}

		// –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
		document.getElementById('previewName').textContent =
			broadcastName || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'
		document.getElementById('previewRecipients').textContent =
			audienceData.recipients || 0
		document.getElementById('previewSchedule').textContent = '–°–µ–π—á–∞—Å'

		// –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä —Å–æ–æ–±—â–µ–Ω–∏—è
		const previewMessage = document.getElementById('previewMessage')
		if (enableMarkdown) {
			// –ü—Ä–æ—Å—Ç–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ Telegram —Ä–∞–∑–º–µ—Ç–∫–∏
			let formattedText = messageText
				.replace(/\*([^*]+)\*/g, '<strong>$1</strong>')
				.replace(/_([^_]+)_/g, '<em>$1</em>')
				.replace(/`([^`]+)`/g, '<code>$1</code>')
				.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
				.replace(/\n/g, '<br>')
			previewMessage.innerHTML = formattedText
		} else {
			previewMessage.textContent = messageText
		}

		// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
		new bootstrap.Modal(document.getElementById('previewModal')).show()
	}

	async function previewRecipients() {
		const targetType = document.querySelector(
			'input[name="target_audience"]:checked'
		).value

		try {
			const response = await fetch(
				`/api/broadcasts/recipients-preview?target_type=${targetType}&limit=50`
			)
			const data = await response.json()

			// –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
			showRecipientsModal(data)
		} catch (error) {
			console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π:', error)
			alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π')
		}
	}

	function submitBroadcast() {
		document.getElementById('broadcastForm').dispatchEvent(new Event('submit'))
	}

	document.addEventListener('DOMContentLoaded', function () {
		// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≤—ã–±–æ—Ä–∞ –¥–∞—Ç—ã/–≤—Ä–µ–º–µ–Ω–∏ (–µ—Å–ª–∏ flatpickr –¥–æ—Å—Ç—É–ø–µ–Ω)
		if (typeof flatpickr !== 'undefined') {
			flatpickr('#scheduleDate', {
				locale: 'ru',
				dateFormat: 'd.m.Y',
				minDate: 'today',
			})

			flatpickr('#scheduleTime', {
				enableTime: true,
				noCalendar: true,
				dateFormat: 'H:i',
				time_24hr: true,
			})
		}

		// –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
		setupEventListeners()

		// –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∞—É–¥–∏—Ç–æ—Ä–∏–∏
		updateAudienceStats()

		// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ)
		// restoreAutoSave()

		// –ó–∞–ø—É—Å–∫ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è (–≤—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ)
		// startAutoSave()
	})

	function setupEventListeners() {
		// –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ç–µ–∫—Å—Ç–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
		const messageTextArea = document.getElementById('messageTextArea')
		messageTextArea.addEventListener('input', function () {
			updatePreview()
			updateCharCount()
		})

		// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∏–ø–∞ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
		document.querySelectorAll('input[name="schedule_type"]').forEach(radio => {
			radio.addEventListener('change', function () {
				const scheduleSection = document.getElementById('scheduleDateTime')
				scheduleSection.style.display =
					this.value === 'later' ? 'block' : 'none'
			})
		})

		// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ü–µ–ª–µ–≤–æ–π –∞—É–¥–∏—Ç–æ—Ä–∏–∏
		document
			.querySelectorAll('input[name="target_audience"]')
			.forEach(radio => {
				radio.addEventListener('change', function () {
					const customSection = document.getElementById('customAudienceSection')
					customSection.style.display =
						this.value === 'custom' ? 'block' : 'none'
					updateAudienceStats()
				})
			})

		// –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ç–∏–ø–∞ —Å–æ–æ–±—â–µ–Ω–∏—è
		const messageTypeSelect = document.getElementById('messageType')
		if (messageTypeSelect) {
			messageTypeSelect.addEventListener('change', function () {
				const mediaSection = document.getElementById('mediaSection')
				if (mediaSection) {
					mediaSection.style.display = this.value !== 'text' ? 'block' : 'none'
				}
			})
		}

		// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–æ–≤
		const uploadArea = document.getElementById('mediaUploadArea')
		const fileInput = document.getElementById('mediaFile')

		if (uploadArea && fileInput) {
			uploadArea.addEventListener('click', () => fileInput.click())
			uploadArea.addEventListener('dragover', handleDragOver)
			uploadArea.addEventListener('drop', handleDrop)
			fileInput.addEventListener('change', handleFileSelect)
		}

		// –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã
		document
			.getElementById('broadcastForm')
			.addEventListener('submit', handleFormSubmit)
	}

	function updatePreview() {
		const messageTextArea = document.getElementById('messageTextArea')
		const content = messageTextArea.value
		const preview = document.getElementById('messagePreview')
		const enableMarkdown = document.getElementById('enableMarkdown').checked

		if (!content.trim()) {
			preview.innerHTML =
				'<em class="text-muted">–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è...</em>'
		} else {
			// –ö–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º —Ç–µ–∫—Å—Ç –≤ Telegram-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç
			const telegramText = enableMarkdown
				? convertMarkdownToHtml(content)
				: escapeHtml(content)
			preview.innerHTML = telegramText
		}
	}

	function updateCharCount() {
		const messageTextArea = document.getElementById('messageTextArea')
		const content = messageTextArea.value
		const charCount = content.length
		const charCountElement = document.getElementById('charCount')
		const charWarning = document.getElementById('charWarning')
		const charError = document.getElementById('charError')

		charCountElement.textContent = `${charCount} —Å–∏–º–≤–æ–ª–æ–≤`

		if (charCount > 4096) {
			charCountElement.className = 'badge bg-danger'
			charWarning.style.display = 'none'
			charError.style.display = 'inline'
		} else if (charCount > 3500) {
			charCountElement.className = 'badge bg-warning'
			charWarning.style.display = 'inline'
			charError.style.display = 'none'
		} else {
			charCountElement.className = 'badge bg-secondary'
			charWarning.style.display = 'none'
			charError.style.display = 'none'
		}
	}

	function convertMarkdownToHtml(text) {
		return text
			.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
			.replace(/\*(.*?)\*/g, '<strong>$1</strong>')
			.replace(/__(.*?)__/g, '<em>$1</em>')
			.replace(/_(.*?)_/g, '<em>$1</em>')
			.replace(/`(.*?)`/g, '<code>$1</code>')
			.replace(/\[([^\]]+)\]\(([^)]+)\)/g, '<a href="$2">$1</a>')
			.replace(/\n/g, '<br>')
	}

	function escapeHtml(text) {
		const div = document.createElement('div')
		div.textContent = text
		return div.innerHTML.replace(/\n/g, '<br>')
	}

	function convertToTelegramFormat(html) {
		// –ü—Ä–æ—Å—Ç–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è HTML –≤ Telegram-—Å–æ–≤–º–µ—Å—Ç–∏–º—ã–π —Ñ–æ—Ä–º–∞—Ç
		return html
			.replace(/<strong>/g, '<b>')
			.replace(/<\/strong>/g, '</b>')
			.replace(/<em>/g, '<i>')
			.replace(/<\/em>/g, '</i>')
			.replace(/<code>/g, '<code>')
			.replace(/<\/code>/g, '</code>')
			.replace(/<p>/g, '')
			.replace(/<\/p>/g, '\n')
			.replace(/<br>/g, '\n')
	}

	async function updateAudienceStats() {
		const targetType = document.querySelector(
			'input[name="target_audience"]:checked'
		).value

		// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
		const recipientCount = document.getElementById('recipientCount')
		recipientCount.innerHTML =
			'<span class="spinner-border spinner-border-sm" role="status"></span>'

		try {
			const response = await fetch(
				`/api/broadcasts/audience-stats?target_type=${targetType}`
			)
			const data = await response.json()

			// –û–±–Ω–æ–≤–ª—è–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
			recipientCount.textContent = data.recipients || 0
			recipientCount.className = 'badge bg-primary fs-6'

			// –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏
			document.getElementById('estimatedTime').textContent =
				data.estimated_time || '-'

			// –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ –∞—É–¥–∏—Ç–æ—Ä–∏–∏
			const audienceDetails = document.getElementById('audienceDetails')
			audienceDetails.innerHTML = `
				<li>–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${data.details.total_users}</li>
				<li>–ê–∫—Ç–∏–≤–Ω—ã—Ö: ${data.details.active_users}</li>
				<li>–ü–æ–¥–ø–∏—Å—á–∏–∫–æ–≤: ${data.details.subscribers}</li>
				<li>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö: ${data.details.blocked_users}</li>
			`

			// –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –≤ –¥—Ä—É–≥–∏—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö
			audienceData = data
		} catch (error) {
			console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∞—É–¥–∏—Ç–æ—Ä–∏–∏:', error)
			recipientCount.textContent = '–û—à–∏–±–∫–∞'
			recipientCount.className = 'badge bg-danger fs-6'
		}
	}

	async function refreshAudienceStats() {
		await updateAudienceStats()
	}

	async function previewRecipients() {
		const targetType = document.querySelector(
			'input[name="target_audience"]:checked'
		).value

		try {
			const response = await fetch(
				`/api/broadcasts/recipients-preview?target_type=${targetType}&limit=50`
			)
			const data = await response.json()

			// –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞
			showRecipientsModal(data)
		} catch (error) {
			console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π:', error)
			alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π')
		}
	}

	function showRecipientsModal(data) {
		const modalHtml = `
			<div class="modal fade" id="recipientsModal" tabindex="-1">
				<div class="modal-dialog modal-lg">
					<div class="modal-content">
						<div class="modal-header">
							<h5 class="modal-title">–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π (${data.total})</h5>
							<button type="button" class="btn-close" data-bs-dismiss="modal"></button>
						</div>
						<div class="modal-body">
							<div class="table-responsive">
								<table class="table table-sm">
									<thead>
										<tr>
											<th>ID</th>
											<th>–ò–º—è</th>
											<th>Username</th>
											<th>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</th>
										</tr>
									</thead>
									<tbody>
										${data.recipients
											.map(
												user => `
											<tr>
												<td>${user.user_id}</td>
												<td>${user.first_name || ''} ${user.last_name || ''}</td>
												<td>@${user.username || '–Ω–µ—Ç'}</td>
												<td>${new Date(user.created_at).toLocaleDateString('ru-RU')}</td>
											</tr>
										`
											)
											.join('')}
									</tbody>
								</table>
							</div>
						</div>
						<div class="modal-footer">
							<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–ó–∞–∫—Ä—ã—Ç—å</button>
						</div>
					</div>
				</div>
			</div>
		`

		// –£–¥–∞–ª—è–µ–º –ø—Ä–µ–¥—ã–¥—É—â–µ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –µ—Å–ª–∏ –µ—Å—Ç—å
		const existingModal = document.getElementById('recipientsModal')
		if (existingModal) {
			existingModal.remove()
		}

		// –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
		document.body.insertAdjacentHTML('beforeend', modalHtml)

		// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
		new bootstrap.Modal(document.getElementById('recipientsModal')).show()
	}

	function toggleTemplates() {
		const section = document.getElementById('templatesSection')
		const toggleText = document.getElementById('templatesToggleText')

		if (section.style.display === 'none') {
			section.style.display = 'block'
			toggleText.textContent = '–°–∫—Ä—ã—Ç—å —à–∞–±–ª–æ–Ω—ã'
		} else {
			section.style.display = 'none'
			toggleText.textContent = '–ü–æ–∫–∞–∑–∞—Ç—å —à–∞–±–ª–æ–Ω—ã'
		}
	}

	function selectTemplate(templateId, content) {
		// –£–±–∏—Ä–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å –¥—Ä—É–≥–∏—Ö —à–∞–±–ª–æ–Ω–æ–≤
		document.querySelectorAll('.template-item').forEach(item => {
			item.classList.remove('selected')
		})

		// –í—ã–¥–µ–ª—è–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω
		document
			.querySelector(`[data-template-id="${templateId}"]`)
			.classList.add('selected')

		// –í—Å—Ç–∞–≤–ª—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ textarea
		const messageTextArea = document.getElementById('messageTextArea')
		messageTextArea.value = content
		updatePreview()
		updateCharCount()
	}

	function handleDragOver(e) {
		e.preventDefault()
		e.currentTarget.classList.add('dragover')
	}

	function handleDrop(e) {
		e.preventDefault()
		e.currentTarget.classList.remove('dragover')

		const files = e.dataTransfer.files
		if (files.length > 0) {
			handleFile(files[0])
		}
	}

	function handleFileSelect(e) {
		const file = e.target.files[0]
		if (file) {
			handleFile(file)
		}
	}

	function handleFile(file) {
		const preview = document.getElementById('mediaPreview')
		const uploadArea = document.getElementById('mediaUploadArea')

		// –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
		const messageType = document.getElementById('messageType').value
		const isImage = file.type.startsWith('image/')
		const isDocument = !isImage

		if (messageType === 'photo' && !isImage) {
			alert('–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ (JPG, PNG)')
			return
		}

		if (messageType === 'document' && isImage) {
			alert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–æ–∫—É–º–µ–Ω—Ç (PDF, DOC, DOCX)')
			return
		}

		// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é
		preview.innerHTML = `
        <div class="d-flex align-items-center">
            <i class="fas fa-${isImage ? 'image' : 'file-alt'} fa-2x me-3"></i>
            <div>
                <strong>${file.name}</strong><br>
                <small class="text-muted">${(file.size / 1024 / 1024).toFixed(
									2
								)} MB</small>
            </div>
            <button type="button" class="btn btn-sm btn-outline-danger ms-auto" onclick="removeFile()">
                üóëÔ∏è
            </button>
        </div>
    `

		preview.style.display = 'block'
		uploadArea.style.display = 'none'
	}

	function removeFile() {
		document.getElementById('mediaFile').value = ''
		document.getElementById('mediaPreview').style.display = 'none'
		document.getElementById('mediaUploadArea').style.display = 'block'
	}

	function previewBroadcast() {
		// –ó–∞–ø–æ–ª–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
		document.getElementById('previewName').textContent =
			document.getElementById('broadcastName').value || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'

		document.getElementById('previewRecipients').textContent =
			document.getElementById('recipientCount').textContent

		const scheduleType = document.querySelector(
			'input[name="schedule_type"]:checked'
		).value
		document.getElementById('previewSchedule').textContent =
			scheduleType === 'now' ? '–ù–µ–º–µ–¥–ª–µ–Ω–Ω–æ' : '–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ'

		document.getElementById('previewMessage').innerHTML =
			document.getElementById('messagePreview').innerHTML

		// –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
		new bootstrap.Modal(document.getElementById('previewModal')).show()
	}

	async function handleFormSubmit(e) {
		e.preventDefault()

		// –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
		const messageText = document.getElementById('messageTextArea').value.trim()
		const broadcastName = document.getElementById('broadcastName').value.trim()

		if (!messageText) {
			alert('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è')
			return
		}

		if (!broadcastName) {
			alert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏')
			return
		}

		if (messageText.length > 4096) {
			alert('–¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π (–º–∞–∫—Å–∏–º—É–º 4096 —Å–∏–º–≤–æ–ª–æ–≤)')
			return
		}

		// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
		const targetType = document.querySelector(
			'input[name="target_audience"]:checked'
		).value
		const sendNow =
			document.querySelector('input[name="schedule_type"]:checked').value ===
			'now'

		// –ü–æ–ª—É—á–∞–µ–º —Å–∫–æ—Ä–æ—Å—Ç—å –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏ –∫–æ–Ω–≤–µ—Ä—Ç–∏—Ä—É–µ–º –≤ —á–∏—Å–ª–æ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –º–∏–Ω—É—Ç—É
		const sendRateElement = document.getElementById('sendRate')
		let sendSpeed = 30 // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
		if (sendRateElement) {
			const rateValue = sendRateElement.value
			if (rateValue === 'slow') sendSpeed = 10
			else if (rateValue === 'normal') sendSpeed = 30
			else if (rateValue === 'fast') sendSpeed = 60
		}

		const skipBlocked = document.getElementById('skipBlocked')?.checked || true
		const saveAsTemplate =
			document.getElementById('saveAsTemplate')?.checked || false
		const parseMode = document.getElementById('enableMarkdown')?.checked
			? 'Markdown'
			: 'HTML'

		const requestData = {
			title: broadcastName,
			message_text: messageText,
			message_type: document.getElementById('messageType')?.value || 'text',
			target_type: targetType,
			send_now: sendNow,
			scheduled_time: sendNow
				? null
				: document.getElementById('scheduledDateTime')?.value,
			send_speed: sendSpeed,
			skip_blocked: skipBlocked,
			save_as_template: saveAsTemplate,
			parse_mode: parseMode,
		}

		try {
			// –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –º–µ–¥–∏–∞—Ñ–∞–π–ª
			const fileInput = document.getElementById('mediaFile')
			const hasMediaFile =
				fileInput && fileInput.files && fileInput.files.length > 0

			let response

			if (hasMediaFile) {
				// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ FormData –¥–ª—è –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤
				const formData = new FormData()
				formData.append('title', broadcastName)
				formData.append('message_text', messageText)
				formData.append('target_users', targetType)
				formData.append('parse_mode', parseMode)
				formData.append('file', fileInput.files[0])

				// –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–¥–ø–∏—Å—å –∫ –º–µ–¥–∏–∞—Ñ–∞–π–ª—É –µ—Å–ª–∏ –µ—Å—Ç—å
				const mediaCaption = document.getElementById('mediaCaption')?.value
				if (mediaCaption) {
					formData.append('media_caption', mediaCaption)
				}

				response = await fetch('/api/media-broadcasts/create', {
					method: 'POST',
					body: formData,
				})
			} else {
				// –û–±—ã—á–Ω–∞—è —Ç–µ–∫—Å—Ç–æ–≤–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞
				response = await fetch('/api/broadcasts/', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
					},
					body: JSON.stringify(requestData),
				})
			}

			if (response.ok) {
				const data = await response.json()
				if (data.success) {
					alert(data.message + `\n–ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π: ${data.target_count}`)
					window.location.href = `/broadcasts/`
				} else {
					alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏')
				}
			} else {
				const error = await response.json()
				alert(`–û—à–∏–±–∫–∞: ${error.detail}`)
			}
		} catch (error) {
			console.error('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏:', error)
			alert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏')
		}
	}

	async function saveDraft() {
		const messageText = document.getElementById('messageTextArea').value.trim()
		const broadcastName = document.getElementById('broadcastName').value.trim()

		if (!messageText && !broadcastName) {
			alert('–ù–µ—á–µ–≥–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å - –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –∏–ª–∏ —Ç–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è')
			return
		}

		// –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞
		const draftData = {
			name: broadcastName || '–ß–µ—Ä–Ω–æ–≤–∏–∫ ' + new Date().toLocaleString('ru-RU'),
			message_text: messageText,
			target_type: document.querySelector(
				'input[name="target_audience"]:checked'
			).value,
			parse_mode: document.getElementById('enableMarkdown').checked
				? 'Markdown'
				: 'HTML',
			send_speed: document.getElementById('sendRate').value,
			skip_blocked: document.getElementById('skipBlocked').checked,
			save_as_template: document.getElementById('saveAsTemplate').checked,
		}

		// –î–æ–±–∞–≤–ª—è–µ–º –∫–∞—Å—Ç–æ–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –µ—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–æ
		if (draftData.target_type === 'custom') {
			draftData.custom_user_ids = document.getElementById('customUserIds').value
		}

		try {
			const response = await fetch('/api/broadcasts/drafts', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json',
				},
				body: JSON.stringify(draftData),
			})

			if (response.ok) {
				const data = await response.json()
				alert('–ß–µ—Ä–Ω–æ–≤–∏–∫ —Å–æ—Ö—Ä–∞–Ω–µ–Ω —É—Å–ø–µ—à–Ω–æ!')
				// –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥–∞ –∫ —Å–ø–∏—Å–∫—É —á–µ—Ä–Ω–æ–≤–∏–∫–æ–≤
			} else {
				const error = await response.json()
				alert(`–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞: ${error.detail}`)
			}
		} catch (error) {
			console.error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞:', error)
			alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —á–µ—Ä–Ω–æ–≤–∏–∫–∞')
		}
	}

	// –ê–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —á–µ—Ä–Ω–æ–≤–∏–∫–∞ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
	let autoSaveInterval
	function startAutoSave() {
		autoSaveInterval = setInterval(() => {
			const messageText = document
				.getElementById('messageTextArea')
				.value.trim()
			const broadcastName = document
				.getElementById('broadcastName')
				.value.trim()

			if (messageText || broadcastName) {
				// –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage –∫–∞–∫ —Ä–µ–∑–µ—Ä–≤–Ω—É—é –∫–æ–ø–∏—é
				const autoSaveData = {
					name: broadcastName,
					message_text: messageText,
					target_type: document.querySelector(
						'input[name="target_audience"]:checked'
					).value,
					timestamp: Date.now(),
				}
				localStorage.setItem('broadcast_autosave', JSON.stringify(autoSaveData))
			}
		}, 30000) // 30 —Å–µ–∫—É–Ω–¥
	}

	// –í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–∑ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è
	function restoreAutoSave() {
		const autoSaveData = localStorage.getItem('broadcast_autosave')
		if (autoSaveData) {
			try {
				const data = JSON.parse(autoSaveData)
				const timeDiff = Date.now() - data.timestamp

				// –ï—Å–ª–∏ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –Ω–µ —Å—Ç–∞—Ä—à–µ 1 —á–∞—Å–∞
				if (timeDiff < 3600000) {
					if (confirm('–ù–∞–π–¥–µ–Ω–æ –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ. –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ?')) {
						document.getElementById('broadcastName').value = data.name || ''
						document.getElementById('messageTextArea').value =
							data.message_text || ''

						// –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–∏–ø –∞—É–¥–∏—Ç–æ—Ä–∏–∏
						const targetRadio = document.querySelector(
							`input[name="target_audience"][value="${data.target_type}"]`
						)
						if (targetRadio) {
							targetRadio.checked = true
						}

						updatePreview()
						updateCharCount()
					}
				}
			} catch (error) {
				console.error('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∞–≤—Ç–æ—Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:', error)
			}
		}
	}
</script>
{% endblock %}
