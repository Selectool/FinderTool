{% extends "base.html" %} {% block title %}–†–∞—Å—Å—ã–ª–∫–∞ #{{ broadcast.id }}{%
endblock %} {% block extra_head %}
<!-- Chart.js –¥–ª—è –≥—Ä–∞—Ñ–∏–∫–æ–≤ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
	.status-badge {
		padding: 6px 12px;
		border-radius: 6px;
		font-weight: 500;
	}
	.status-pending {
		background-color: #fef3c7;
		color: #92400e;
	}
	.status-sending {
		background-color: #dbeafe;
		color: #1e40af;
	}
	.status-completed {
		background-color: #d1fae5;
		color: #065f46;
	}
	.status-failed {
		background-color: #fee2e2;
		color: #991b1b;
	}
	.status-paused {
		background-color: #f3e8ff;
		color: #7c3aed;
	}

	.progress-circle {
		width: 120px;
		height: 120px;
		border-radius: 50%;
		background: conic-gradient(
			#10b981 0deg,
			#10b981 var(--progress, 0deg),
			#e5e7eb var(--progress, 0deg)
		);
		display: flex;
		align-items: center;
		justify-content: center;
		position: relative;
	}

	.progress-circle::before {
		content: '';
		width: 80px;
		height: 80px;
		border-radius: 50%;
		background: white;
		position: absolute;
	}

	.progress-text {
		position: relative;
		z-index: 1;
		font-weight: bold;
		font-size: 1.2rem;
	}

	.message-preview {
		background: #f8f9fa;
		border: 1px solid #dee2e6;
		border-radius: 8px;
		padding: 1rem;
		max-height: 300px;
		overflow-y: auto;
	}

	.log-entry {
		padding: 8px 12px;
		border-left: 3px solid #dee2e6;
		margin-bottom: 8px;
		font-size: 0.9rem;
	}

	.log-success {
		border-left-color: #10b981;
		background-color: #f0fdf4;
	}
	.log-error {
		border-left-color: #ef4444;
		background-color: #fef2f2;
	}
	.log-warning {
		border-left-color: #f59e0b;
		background-color: #fffbeb;
	}
	.log-info {
		border-left-color: #3b82f6;
		background-color: #eff6ff;
	}

	.real-time-stats {
		border: 2px solid #e5e7eb;
		border-radius: 8px;
		padding: 1rem;
		background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
	}

	.control-button {
		min-width: 120px;
	}
</style>
{% endblock %} {% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
	<div>
		<h1>üì¢ –†–∞—Å—Å—ã–ª–∫–∞ #{{ broadcast.id }}</h1>
		{% if broadcast.name %}
		<p class="text-muted mb-0">{{ broadcast.name }}</p>
		{% endif %}
	</div>
	<div>
		<a href="/broadcasts/" class="btn btn-outline-secondary me-2">
			‚Üê –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
		</a>
		{% if broadcast.status == 'completed' %}
		<button class="btn btn-outline-primary" onclick="duplicateBroadcast()">
			üìã –î—É–±–ª–∏—Ä–æ–≤–∞—Ç—å
		</button>
		{% endif %}
	</div>
</div>

<!-- –°—Ç–∞—Ç—É—Å –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ -->
<div class="row mb-4">
	<div class="col-md-8">
		<div class="card">
			<div class="card-body">
				<div class="d-flex justify-content-between align-items-center">
					<div>
						<h5 class="mb-1">
							–°—Ç–∞—Ç—É—Å:
							<span
								class="status-badge status-{{ broadcast.status or 'pending' }}"
							>
								{% if broadcast.status == 'pending' %}‚è≥ –û–∂–∏–¥–∞–µ—Ç –∑–∞–ø—É—Å–∫–∞ {% elif
								broadcast.status == 'sending' %}üì§ –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è {% elif
								broadcast.status == 'completed' %}‚úÖ –ó–∞–≤–µ—Ä—à–µ–Ω–∞ {% elif
								broadcast.status == 'failed' %}‚ùå –û—à–∏–±–∫–∞ {% elif
								broadcast.status == 'paused' %}‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ {% else %}‚è≥
								–û–∂–∏–¥–∞–µ—Ç –∑–∞–ø—É—Å–∫–∞ {% endif %}
							</span>
						</h5>
						<p class="text-muted mb-0">
							–°–æ–∑–¥–∞–Ω–æ: {{ broadcast.created_at.strftime('%d.%m.%Y –≤ %H:%M') if
							broadcast.created_at else '-' }}
						</p>
						{% if broadcast.started_at %}
						<p class="text-muted mb-0">
							–ó–∞–ø—É—â–µ–Ω–æ: {{ broadcast.started_at.strftime('%d.%m.%Y –≤ %H:%M') }}
						</p>
						{% endif %} {% if broadcast.completed_at %}
						<p class="text-muted mb-0">
							–ó–∞–≤–µ—Ä—à–µ–Ω–æ: {{ broadcast.completed_at.strftime('%d.%m.%Y –≤ %H:%M')
							}}
						</p>
						{% endif %}
					</div>

					<div class="text-end">
						{% if broadcast.status == 'pending' %}
						<button
							class="btn btn-success control-button me-2"
							onclick="startBroadcast()"
						>
							‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å
						</button>
						<button
							class="btn btn-outline-danger control-button"
							onclick="deleteBroadcast()"
						>
							üóëÔ∏è –£–¥–∞–ª–∏—Ç—å
						</button>
						{% elif broadcast.status == 'sending' %}
						<button
							class="btn btn-warning control-button me-2"
							onclick="pauseBroadcast()"
						>
							‚è∏Ô∏è –ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
						</button>
						<button
							class="btn btn-danger control-button"
							onclick="stopBroadcast()"
						>
							‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
						</button>
						{% elif broadcast.status == 'paused' %}
						<button
							class="btn btn-success control-button me-2"
							onclick="resumeBroadcast()"
						>
							‚ñ∂Ô∏è –í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å
						</button>
						<button
							class="btn btn-danger control-button"
							onclick="stopBroadcast()"
						>
							‚èπÔ∏è –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å
						</button>
						{% endif %}
					</div>
				</div>

				{% if broadcast.error_message %}
				<div class="alert alert-danger mt-3">
					<strong>–û—à–∏–±–∫–∞:</strong> {{ broadcast.error_message }}
				</div>
				{% endif %}
			</div>
		</div>
	</div>

	<div class="col-md-4">
		<div class="card">
			<div class="card-body text-center">
				<h6 class="card-title">–ü—Ä–æ–≥—Ä–µ—Å—Å –æ—Ç–ø—Ä–∞–≤–∫–∏</h6>
				{% set total = (broadcast.sent_count or 0) + (broadcast.failed_count or
				0) %} {% set sent = broadcast.sent_count or 0 %} {% if total > 0 %} {%
				set progress_percent = (sent / total * 100)|round(1) %} {% set
				progress_deg = (sent / total * 360)|round(0) %}
				<div
					class="progress-circle mx-auto mb-3"
					style="--progress: {{ progress_deg }}deg;"
				>
					<div class="progress-text">{{ progress_percent }}%</div>
				</div>
				<p class="mb-0">{{ sent }} –∏–∑ {{ total }}</p>
				{% else %}
				<div class="progress-circle mx-auto mb-3" style="--progress: 0deg">
					<div class="progress-text">0%</div>
				</div>
				<p class="mb-0">–ù–µ –∑–∞–ø—É—â–µ–Ω–∞</p>
				{% endif %}
			</div>
		</div>
	</div>
</div>

<!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏ -->
{% if broadcast.status == 'sending' %}
<div class="card mb-4">
	<div class="card-header">
		<h5 class="mb-0">üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏</h5>
	</div>
	<div class="card-body">
		<div class="real-time-stats" id="realTimeStats">
			<div class="row text-center">
				<div class="col-md-3">
					<h4 class="text-success" id="sentCount">
						{{ broadcast.sent_count or 0 }}
					</h4>
					<p class="mb-0">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</p>
				</div>
				<div class="col-md-3">
					<h4 class="text-danger" id="failedCount">
						{{ broadcast.failed_count or 0 }}
					</h4>
					<p class="mb-0">–û—à–∏–±–∫–∏</p>
				</div>
				<div class="col-md-3">
					<h4 class="text-info" id="currentRate">-</h4>
					<p class="mb-0">–°–æ–æ–±—â–µ–Ω–∏–π/–º–∏–Ω</p>
				</div>
				<div class="col-md-3">
					<h4 class="text-warning" id="estimatedTime">-</h4>
					<p class="mb-0">–û—Å—Ç–∞–ª–æ—Å—å –≤—Ä–µ–º–µ–Ω–∏</p>
				</div>
			</div>
		</div>
	</div>
</div>
{% endif %}

<!-- –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
<div class="row mb-4">
	<div class="col-md-6">
		<div class="card">
			<div class="card-header">
				<h5 class="mb-0">üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</h5>
			</div>
			<div class="card-body">
				<canvas id="deliveryChart" width="400" height="200"></canvas>
			</div>
		</div>
	</div>

	<div class="col-md-6">
		<div class="card">
			<div class="card-header">
				<h5 class="mb-0">üìä –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h5>
			</div>
			<div class="card-body">
				<table class="table table-sm">
					<tr>
						<td>‚úÖ –£—Å–ø–µ—à–Ω–æ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–æ:</td>
						<td class="text-end">
							<strong>{{ stats.delivered or 0 }}</strong>
						</td>
					</tr>
					<tr>
						<td>‚ùå –û—à–∏–±–∫–∏ –¥–æ—Å—Ç–∞–≤–∫–∏:</td>
						<td class="text-end"><strong>{{ stats.failed or 0 }}</strong></td>
					</tr>
					<tr>
						<td>üö´ –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∏ –±–æ—Ç–∞:</td>
						<td class="text-end"><strong>{{ stats.blocked or 0 }}</strong></td>
					</tr>
					<tr>
						<td>‚è≠Ô∏è –ü—Ä–æ–ø—É—â–µ–Ω–æ:</td>
						<td class="text-end"><strong>{{ stats.skipped or 0 }}</strong></td>
					</tr>
					<tr class="table-active">
						<td><strong>üìä –í—Å–µ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π:</strong></td>
						<td class="text-end">
							<strong>{{ stats.total_recipients or 0 }}</strong>
						</td>
					</tr>
				</table>

				{% if stats.total_recipients > 0 %}
				<div class="mt-3">
					<small class="text-muted">
						–£—Å–ø–µ—à–Ω–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏:
						<strong
							>{{ ((stats.delivered or 0) / stats.total_recipients *
							100)|round(1) }}%</strong
						>
					</small>
				</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>

<!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è -->
<div class="row mb-4">
	<div class="col-md-8">
		<div class="card">
			<div class="card-header">
				<h5 class="mb-0">üìù –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —Å–æ–æ–±—â–µ–Ω–∏—è</h5>
			</div>
			<div class="card-body">
				<div class="message-preview">
					{% set msg_text = broadcast.message_text if broadcast.message_text
					else (broadcast['message_text'] if broadcast.get('message_text') else
					(broadcast.message if broadcast.message else broadcast['message'])) %}
					{{ msg_text|safe if msg_text else '–ù–µ—Ç —Ç–µ–∫—Å—Ç–∞' }}
				</div>

				<div class="mt-3">
					<small class="text-muted">
						–°–∏–º–≤–æ–ª–æ–≤: {{ msg_text|length if msg_text else 0 }} | –§–æ—Ä–º–∞—Ç: {{
						broadcast.parse_mode or broadcast['parse_mode'] or 'HTML' }}
					</small>
				</div>
			</div>
		</div>
	</div>

	<div class="col-md-4">
		<div class="card">
			<div class="card-header">
				<h5 class="mb-0">üéØ –¶–µ–ª–µ–≤–∞—è –∞—É–¥–∏—Ç–æ—Ä–∏—è</h5>
			</div>
			<div class="card-body">
				<p class="mb-2">
					<strong>–¢–∏–ø:</strong>
					{% if broadcast.target_users == 'all' %}üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ {% elif
					broadcast.target_users == 'subscribers' %}üíé –ü–æ–¥–ø–∏—Å—á–∏–∫–∏ {% elif
					broadcast.target_users == 'active' %}üü¢ –ê–∫—Ç–∏–≤–Ω—ã–µ {% else %}üéØ
					–í—ã–±–æ—Ä–æ—á–Ω–æ {% endif %}
				</p>

				{% if broadcast.scheduled_at %}
				<p class="mb-2">
					<strong>–ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –Ω–∞:</strong><br />
					{{ broadcast.scheduled_at.strftime('%d.%m.%Y –≤ %H:%M') }}
				</p>
				{% endif %}

				<p class="mb-0">
					<strong>–°–æ–∑–¥–∞–ª:</strong> {{ broadcast.created_by_name or '–°–∏—Å—Ç–µ–º–∞' }}
				</p>
			</div>
		</div>
	</div>
</div>

<!-- –õ–æ–≥–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ -->
<div class="card">
	<div class="card-header d-flex justify-content-between align-items-center">
		<h5 class="mb-0">üìã –õ–æ–≥–∏ –æ—Ç–ø—Ä–∞–≤–∫–∏</h5>
		<div>
			<button class="btn btn-sm btn-outline-primary" onclick="refreshLogs()">
				üîÑ –û–±–Ω–æ–≤–∏—Ç—å
			</button>
			<button class="btn btn-sm btn-outline-secondary" onclick="exportLogs()">
				üì• –≠–∫—Å–ø–æ—Ä—Ç
			</button>
		</div>
	</div>
	<div class="card-body">
		<div id="logsContainer" style="max-height: 400px; overflow-y: auto">
			<!-- –õ–æ–≥–∏ –±—É–¥—É—Ç –∑–∞–≥—Ä—É–∂–µ–Ω—ã —á–µ—Ä–µ–∑ AJAX -->
			<div class="text-center py-3">
				<div class="spinner-border spinner-border-sm" role="status">
					<span class="visually-hidden">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
				</div>
				<p class="mt-2 mb-0">–ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤...</p>
			</div>
		</div>
	</div>
</div>
{% endblock %} {% block extra_js %}
<script>
	// –ü–æ–ª—É—á–∞–µ–º ID —Ä–∞—Å—Å—ã–ª–∫–∏ –∏–∑ URL
	const broadcastId = parseInt(window.location.pathname.split('/').pop()) || {{ broadcast.id or 0 }};
	let deliveryChart;

	document.addEventListener('DOMContentLoaded', function() {
	    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –≥—Ä–∞—Ñ–∏–∫–∞
	    initDeliveryChart();

	    // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ–≤
	    loadLogs();

	    // –ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Ä–∞—Å—Å—ã–ª–æ–∫
	    {% if broadcast.status == 'sending' %}
	    setInterval(updateRealTimeStats, 5000);
	    {% endif %}
	});

	function initDeliveryChart() {
	    const ctx = document.getElementById('deliveryChart').getContext('2d');

	    deliveryChart = new Chart(ctx, {
	        type: 'doughnut',
	        data: {
	            labels: ['–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ', '–û—à–∏–±–∫–∏', '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ', '–û–∂–∏–¥–∞–µ—Ç'],
	            datasets: [{
	                data: [
	                    {{ stats.delivered or 0 }},
	                    {{ stats.failed or 0 }},
	                    {{ stats.blocked or 0 }},
	                    {{ (stats.total_recipients or 0) - (stats.delivered or 0) - (stats.failed or 0) - (stats.blocked or 0) }}
	                ],
	                backgroundColor: [
	                    '#10b981',
	                    '#ef4444',
	                    '#f59e0b',
	                    '#e5e7eb'
	                ],
	                borderWidth: 2,
	                borderColor: '#ffffff'
	            }]
	        },
	        options: {
	            responsive: true,
	            maintainAspectRatio: false,
	            plugins: {
	                legend: {
	                    position: 'bottom'
	                }
	            }
	        }
	    });
	}

	async function updateRealTimeStats() {
	    try {
	        const response = await fetch(`/api/broadcasts/${broadcastId}/stats`);
	        if (response.ok) {
	            const data = await response.json();

	            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏
	            document.getElementById('sentCount').textContent = data.sent_count || 0;
	            document.getElementById('failedCount').textContent = data.failed_count || 0;
	            document.getElementById('currentRate').textContent = data.current_rate || '-';
	            document.getElementById('estimatedTime').textContent = data.estimated_time || '-';

	            // –û–±–Ω–æ–≤–ª—è–µ–º –≥—Ä–∞—Ñ–∏–∫
	            if (deliveryChart) {
	                deliveryChart.data.datasets[0].data = [
	                    data.delivered || 0,
	                    data.failed || 0,
	                    data.blocked || 0,
	                    (data.total_recipients || 0) - (data.delivered || 0) - (data.failed || 0) - (data.blocked || 0)
	                ];
	                deliveryChart.update();
	            }

	            // –ï—Å–ª–∏ —Ä–∞—Å—Å—ã–ª–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞, –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
	            if (data.status === 'completed' || data.status === 'failed') {
	                setTimeout(() => location.reload(), 2000);
	            }
	        }
	    } catch (error) {
	        console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏:', error);
	    }
	}

	async function loadLogs() {
	    try {
	        const response = await fetch(`/api/broadcasts/${broadcastId}/logs`);
	        if (response.ok) {
	            const data = await response.json();
	            displayLogs(data.logs);
	        } else {
	            // –û–±—Ä–∞–±–æ—Ç–∫–∞ HTTP –æ—à–∏–±–æ–∫
	            console.error('HTTP –æ—à–∏–±–∫–∞:', response.status, response.statusText);

	            if (response.status === 401) {
	                // –û—à–∏–±–∫–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ - –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ª–æ–≥–∏–Ω
	                window.location.href = '/auth/login';
	                return;
	            }

	            // –î—Ä—É–≥–∏–µ HTTP –æ—à–∏–±–∫–∏
	            const errorData = await response.json().catch(() => ({}));
	            const errorMessage = errorData.detail || `HTTP ${response.status}: ${response.statusText}`;

	            document.getElementById('logsContainer').innerHTML =
	                `<div class="text-center text-danger">
	                    <i class="fas fa-exclamation-triangle mb-2"></i><br>
	                    –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤: ${errorMessage}
	                    <br><br>
	                    <button class="btn btn-outline-primary btn-sm" onclick="loadLogs()">
	                        <i class="fas fa-redo"></i> –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
	                    </button>
	                </div>`;
	        }
	    } catch (error) {
	        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–æ–≥–æ–≤:', error);
	        document.getElementById('logsContainer').innerHTML =
	            `<div class="text-center text-danger">
	                <i class="fas fa-exclamation-triangle mb-2"></i><br>
	                –û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞
	                <br><br>
	                <button class="btn btn-outline-primary btn-sm" onclick="loadLogs()">
	                    <i class="fas fa-redo"></i> –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
	                </button>
	            </div>`;
	    }
	}

	function displayLogs(logs) {
	    const container = document.getElementById('logsContainer');

	    if (logs.length === 0) {
	        container.innerHTML = '<div class="text-center text-muted">–õ–æ–≥–æ–≤ –ø–æ–∫–∞ –Ω–µ—Ç</div>';
	        return;
	    }

	    const logsHtml = logs.map(log => {
	        const logClass = getLogClass(log.status);
	        const icon = getLogIcon(log.status);

	        return `
	            <div class="log-entry ${logClass}">
	                <div class="d-flex justify-content-between">
	                    <span>${icon} ${log.message}</span>
	                    <small class="text-muted">${formatDateTime(log.created_at)}</small>
	                </div>
	                ${log.error_details ? `<small class="text-muted d-block mt-1">${log.error_details}</small>` : ''}
	            </div>
	        `;
	    }).join('');

	    container.innerHTML = logsHtml;
	}

	function getLogClass(status) {
	    switch (status) {
	        case 'sent': return 'log-success';
	        case 'failed': return 'log-error';
	        case 'blocked': return 'log-warning';
	        default: return 'log-info';
	    }
	}

	function getLogIcon(status) {
	    switch (status) {
	        case 'sent': return '‚úÖ';
	        case 'failed': return '‚ùå';
	        case 'blocked': return 'üö´';
	        default: return '‚ÑπÔ∏è';
	    }
	}

	function formatDateTime(dateString) {
	    const date = new Date(dateString);
	    return date.toLocaleString('ru-RU');
	}

	// –§—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–æ–π
	async function startBroadcast() {
	    if (!confirm('–ó–∞–ø—É—Å—Ç–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

	    try {
	        const response = await fetch(`/api/broadcasts/${broadcastId}/start`, {
	            method: 'POST'
	        });

	        if (response.ok) {
	            location.reload();
	        } else {
	            alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏');
	        }
	    } catch (error) {
	        console.error('–û—à–∏–±–∫–∞:', error);
	        alert('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–∞—Å—Å—ã–ª–∫–∏');
	    }
	}

	async function pauseBroadcast() {
	    if (!confirm('–ü—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É?')) return;

	    try {
	        const response = await fetch(`/api/broadcasts/${broadcastId}/pause`, {
	            method: 'POST'
	        });

	        if (response.ok) {
	            location.reload();
	        } else {
	            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏');
	        }
	    } catch (error) {
	        console.error('–û—à–∏–±–∫–∞:', error);
	        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏–æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏');
	    }
	}

	async function resumeBroadcast() {
	    if (!confirm('–í–æ–∑–æ–±–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É?')) return;

	    try {
	        const response = await fetch(`/api/broadcasts/${broadcastId}/resume`, {
	            method: 'POST'
	        });

	        if (response.ok) {
	            location.reload();
	        } else {
	            alert('–û—à–∏–±–∫–∞ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏');
	        }
	    } catch (error) {
	        console.error('–û—à–∏–±–∫–∞:', error);
	        alert('–û—à–∏–±–∫–∞ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏');
	    }
	}

	async function stopBroadcast() {
	    if (!confirm('–û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

	    try {
	        const response = await fetch(`/api/broadcasts/${broadcastId}/stop`, {
	            method: 'POST'
	        });

	        if (response.ok) {
	            location.reload();
	        } else {
	            alert('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏');
	        }
	    } catch (error) {
	        console.error('–û—à–∏–±–∫–∞:', error);
	        alert('–û—à–∏–±–∫–∞ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Ä–∞—Å—Å—ã–ª–∫–∏');
	    }
	}

	async function deleteBroadcast() {
	    if (!confirm('–£–¥–∞–ª–∏—Ç—å —Ä–∞—Å—Å—ã–ª–∫—É? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;

	    try {
	        const response = await fetch(`/api/broadcasts/${broadcastId}`, {
	            method: 'DELETE'
	        });

	        if (response.ok) {
	            window.location.href = '/broadcasts/';
	        } else {
	            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏');
	        }
	    } catch (error) {
	        console.error('–û—à–∏–±–∫–∞:', error);
	        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ä–∞—Å—Å—ã–ª–∫–∏');
	    }
	}

	function duplicateBroadcast() {
	    window.location.href = `/broadcasts/create?duplicate=${broadcastId}`;
	}

	function refreshLogs() {
	    loadLogs();
	}

	async function exportLogs() {
	    try {
	        const response = await fetch(`/api/broadcasts/${broadcastId}/logs/export`);
	        if (response.ok) {
	            const blob = await response.blob();
	            const url = window.URL.createObjectURL(blob);
	            const a = document.createElement('a');
	            a.href = url;
	            a.download = `broadcast_${broadcastId}_logs.csv`;
	            document.body.appendChild(a);
	            a.click();
	            window.URL.revokeObjectURL(url);
	            document.body.removeChild(a);
	        } else {
	            alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –ª–æ–≥–æ–≤');
	        }
	    } catch (error) {
	        console.error('–û—à–∏–±–∫–∞:', error);
	        alert('–û—à–∏–±–∫–∞ —ç–∫—Å–ø–æ—Ä—Ç–∞ –ª–æ–≥–æ–≤');
	    }
	}
</script>
{% endblock %}
