{% extends "base.html" %}

{% block title %}{% if template %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞{% else %}–°–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞{% endif %}{% endblock %}

{% block extra_head %}
<!-- Quill Rich Text Editor -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>

<style>
.preview-panel {
    border: 1px solid #dee2e6;
    border-radius: 0.375rem;
    padding: 1rem;
    background-color: #f8f9fa;
    min-height: 200px;
}

.telegram-message {
    background: white;
    border-radius: 12px;
    padding: 12px 16px;
    max-width: 400px;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    font-size: 14px;
    line-height: 1.4;
}

#editor {
    height: 300px;
}

.category-info {
    background: #e3f2fd;
    border-radius: 8px;
    padding: 12px;
    margin-top: 8px;
}
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>üìù {% if template %}–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞{% else %}–°–æ–∑–¥–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞{% endif %}</h1>
    <a href="/broadcasts/templates" class="btn btn-outline-secondary">
        ‚Üê –ö —à–∞–±–ª–æ–Ω–∞–º
    </a>
</div>

<form id="templateForm">
    <div class="row">
        <!-- –û—Å–Ω–æ–≤–Ω–∞—è —Ñ–æ—Ä–º–∞ -->
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —à–∞–±–ª–æ–Ω–µ</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="templateName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞ *</label>
                        <input type="text" class="form-control" id="templateName" name="name" 
                               value="{{ template.name if template else '' }}" 
                               placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ" required>
                        <div class="form-text">–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞</div>
                    </div>

                    <div class="mb-3">
                        <label for="templateCategory" class="form-label">–ö–∞—Ç–µ–≥–æ—Ä–∏—è</label>
                        <select class="form-select" id="templateCategory" name="category">
                            <option value="general" {% if template and template.category == 'general' %}selected{% endif %}>
                                üìÑ –û–±—â–∏–µ
                            </option>
                            <option value="promotion" {% if template and template.category == 'promotion' %}selected{% endif %}>
                                üéâ –ê–∫—Ü–∏–∏ –∏ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è
                            </option>
                            <option value="notification" {% if template and template.category == 'notification' %}selected{% endif %}>
                                üîî –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                            </option>
                            <option value="welcome" {% if template and template.category == 'welcome' %}selected{% endif %}>
                                üëã –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ
                            </option>
                            <option value="support" {% if template and template.category == 'support' %}selected{% endif %}>
                                üÜò –ü–æ–¥–¥–µ—Ä–∂–∫–∞
                            </option>
                        </select>
                        
                        <div class="category-info" id="categoryInfo">
                            <small class="text-muted">
                                <strong>–û–±—â–∏–µ:</strong> –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ü–µ–ª–µ–π
                            </small>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label for="templateDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                        <textarea class="form-control" id="templateDescription" name="description" rows="2" 
                                  placeholder="–ö—Ä–∞—Ç–∫–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —à–∞–±–ª–æ–Ω">{{ template.description if template else '' }}</textarea>
                    </div>
                </div>
            </div>

            <!-- –†–µ–¥–∞–∫—Ç–æ—Ä —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">‚úèÔ∏è –°–æ–¥–µ—Ä–∂–∏–º–æ–µ —à–∞–±–ª–æ–Ω–∞</h5>
                </div>
                <div class="card-body">
                    <div id="editor">{{ template.content if template else '' }}</div>
                    <input type="hidden" id="templateContent" name="content">
                    
                    <div class="mt-3">
                        <small class="text-muted">
                            üí° –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è: <strong>–∂–∏—Ä–Ω—ã–π</strong>, <em>–∫—É—Ä—Å–∏–≤</em>, 
                            <code>–º–æ–Ω–æ—à–∏—Ä–∏–Ω–Ω—ã–π</code>, —Å—Å—ã–ª–∫–∏ –∏ —ç–º–æ–¥–∑–∏
                        </small>
                    </div>
                    
                    <div class="mt-2">
                        <span class="badge bg-secondary" id="charCount">0 —Å–∏–º–≤–æ–ª–æ–≤</span>
                        <span class="badge bg-warning" id="charWarning" style="display: none;">
                            –ü—Ä–µ–≤—ã—à–µ–Ω –ª–∏–º–∏—Ç Telegram (4096 —Å–∏–º–≤–æ–ª–æ–≤)
                        </span>
                    </div>
                </div>
            </div>

            <!-- –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω–∞ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">üîß –ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ —à–∞–±–ª–æ–Ω–∞</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">
                        –í—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –≤ —Ç–µ–∫—Å—Ç–µ —à–∞–±–ª–æ–Ω–∞:
                    </p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <code>{user_name}</code>
                                    <small class="text-muted">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</small>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <code>{user_id}</code>
                                    <small class="text-muted">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</small>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <code>{current_date}</code>
                                    <small class="text-muted">–¢–µ–∫—É—â–∞—è –¥–∞—Ç–∞</small>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <code>{bot_name}</code>
                                    <small class="text-muted">–ù–∞–∑–≤–∞–Ω–∏–µ –±–æ—Ç–∞</small>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <code>{subscription_end}</code>
                                    <small class="text-muted">–û–∫–æ–Ω—á–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏</small>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <code>{requests_left}</code>
                                    <small class="text-muted">–û—Å—Ç–∞–ª–æ—Å—å –∑–∞–ø—Ä–æ—Å–æ–≤</small>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-3">
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="insertVariable('{user_name}')">
                            –í—Å—Ç–∞–≤–∏—Ç—å {user_name}
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-primary" onclick="insertVariable('{current_date}')">
                            –í—Å—Ç–∞–≤–∏—Ç—å {current_date}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å -->
        <div class="col-lg-4">
            <!-- –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">üëÅÔ∏è –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä</h5>
                </div>
                <div class="card-body">
                    <div class="preview-panel">
                        <div class="telegram-message" id="messagePreview">
                            <em class="text-muted">–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —à–∞–±–ª–æ–Ω–∞...</em>
                        </div>
                    </div>
                </div>
            </div>

            <!-- –ù–∞—Å—Ç—Ä–æ–π–∫–∏ -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label for="parseMode" class="form-label">–†–µ–∂–∏–º —Ä–∞–∑–º–µ—Ç–∫–∏</label>
                        <select class="form-select" id="parseMode" name="parse_mode">
                            <option value="HTML" {% if not template or template.parse_mode == 'HTML' %}selected{% endif %}>
                                HTML
                            </option>
                            <option value="Markdown" {% if template and template.parse_mode == 'Markdown' %}selected{% endif %}>
                                Markdown
                            </option>
                        </select>
                        <div class="form-text">
                            HTML —Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –¥–ª—è –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–∞ —Å–ª—É—á–∞–µ–≤
                        </div>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input" type="checkbox" id="isActive" name="is_active" 
                               {% if not template or template.is_active %}checked{% endif %}>
                        <label class="form-check-label" for="isActive">
                            –ê–∫—Ç–∏–≤–Ω—ã–π —à–∞–±–ª–æ–Ω
                        </label>
                        <div class="form-text">
                            –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ –≤—ã–±–æ—Ä–∞
                        </div>
                    </div>
                </div>
            </div>

            <!-- –î–µ–π—Å—Ç–≤–∏—è -->
            <div class="card">
                <div class="card-body">
                    <button type="button" class="btn btn-outline-primary w-100 mb-2" onclick="testTemplate()">
                        üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —à–∞–±–ª–æ–Ω
                    </button>
                    
                    <button type="submit" class="btn btn-success w-100 mb-2">
                        üíæ {% if template %}–°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è{% else %}–°–æ–∑–¥–∞—Ç—å —à–∞–±–ª–æ–Ω{% endif %}
                    </button>
                    
                    {% if template %}
                    <button type="button" class="btn btn-outline-danger w-100" onclick="deleteTemplate()">
                        üóëÔ∏è –£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω
                    </button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</form>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
<div class="modal fade" id="testModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">üß™ –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —à–∞–±–ª–æ–Ω–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="testUserId" class="form-label">ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</label>
                    <input type="number" class="form-control" id="testUserId" 
                           placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à Telegram ID">
                    <div class="form-text">
                        –°–æ–æ–±—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ —É–∫–∞–∑–∞–Ω–Ω–æ–º—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
                    </div>
                </div>
                
                <div class="alert alert-info">
                    <strong>–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä:</strong>
                    <div id="testPreview" class="mt-2 p-2 bg-light rounded">
                        <!-- –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è -->
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    –û—Ç–º–µ–Ω–∞
                </button>
                <button type="button" class="btn btn-primary" onclick="sendTestMessage()">
                    üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ—Å—Ç
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
let quill;
const templateId = {{ template.id if template else 'null' }};

document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Quill
    quill = new Quill('#editor', {
        theme: 'snow',
        placeholder: '–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —à–∞–±–ª–æ–Ω–∞...',
        modules: {
            toolbar: [
                ['bold', 'italic', 'code'],
                ['link'],
                [{ 'list': 'ordered'}, { 'list': 'bullet' }],
                ['clean']
            ]
        }
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
    quill.on('text-change', function() {
        updatePreview();
        updateCharCount();
    });

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–ø–∏—Å–∞–Ω–∏—è –∫–∞—Ç–µ–≥–æ—Ä–∏–∏
    document.getElementById('templateCategory').addEventListener('change', updateCategoryInfo);
    
    // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    document.getElementById('templateForm').addEventListener('submit', handleFormSubmit);
    
    // –ü–µ—Ä–≤–æ–Ω–∞—á–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    updatePreview();
    updateCharCount();
    updateCategoryInfo();
});

function updatePreview() {
    const content = quill.root.innerHTML;
    const preview = document.getElementById('messagePreview');
    
    if (content.trim() === '<p><br></p>' || !content.trim()) {
        preview.innerHTML = '<em class="text-muted">–í–≤–µ–¥–∏—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —à–∞–±–ª–æ–Ω–∞...</em>';
    } else {
        // –ó–∞–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –Ω–∞ –ø—Ä–∏–º–µ—Ä—ã
        let previewContent = content
            .replace(/{user_name}/g, '<strong>–ò–≤–∞–Ω</strong>')
            .replace(/{user_id}/g, '123456789')
            .replace(/{current_date}/g, new Date().toLocaleDateString('ru-RU'))
            .replace(/{bot_name}/g, 'Channel Finder Bot')
            .replace(/{subscription_end}/g, '31.12.2024')
            .replace(/{requests_left}/g, '5');
        
        preview.innerHTML = previewContent;
    }
}

function updateCharCount() {
    const text = quill.getText();
    const count = text.length;
    const countElement = document.getElementById('charCount');
    const warningElement = document.getElementById('charWarning');
    
    countElement.textContent = `${count} —Å–∏–º–≤–æ–ª–æ–≤`;
    
    if (count > 4096) {
        countElement.className = 'badge bg-danger';
        warningElement.style.display = 'inline';
    } else if (count > 3500) {
        countElement.className = 'badge bg-warning';
        warningElement.style.display = 'none';
    } else {
        countElement.className = 'badge bg-secondary';
        warningElement.style.display = 'none';
    }
}

function updateCategoryInfo() {
    const category = document.getElementById('templateCategory').value;
    const infoElement = document.getElementById('categoryInfo');
    
    const descriptions = {
        'general': '<strong>–û–±—â–∏–µ:</strong> –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–µ —à–∞–±–ª–æ–Ω—ã –¥–ª—è —Ä–∞–∑–ª–∏—á–Ω—ã—Ö —Ü–µ–ª–µ–π',
        'promotion': '<strong>–ê–∫—Ü–∏–∏:</strong> –†–µ–∫–ª–∞–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, —Å–∫–∏–¥–∫–∏, —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è',
        'notification': '<strong>–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:</strong> –°–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è, –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è',
        'welcome': '<strong>–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ:</strong> –°–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π',
        'support': '<strong>–ü–æ–¥–¥–µ—Ä–∂–∫–∞:</strong> –û—Ç–≤–µ—Ç—ã –Ω–∞ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã, –ø–æ–º–æ—â—å'
    };
    
    infoElement.innerHTML = `<small class="text-muted">${descriptions[category]}</small>`;
}

function insertVariable(variable) {
    const range = quill.getSelection();
    if (range) {
        quill.insertText(range.index, variable);
    } else {
        quill.insertText(quill.getLength() - 1, variable);
    }
    quill.focus();
}

function testTemplate() {
    document.getElementById('testPreview').innerHTML = document.getElementById('messagePreview').innerHTML;
    new bootstrap.Modal(document.getElementById('testModal')).show();
}

async function sendTestMessage() {
    const userId = document.getElementById('testUserId').value;
    if (!userId) {
        alert('–í–≤–µ–¥–∏—Ç–µ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
        return;
    }
    
    const content = quill.root.innerHTML;
    
    try {
        const response = await fetch('/api/templates/test', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                user_id: parseInt(userId),
                content: content,
                parse_mode: document.getElementById('parseMode').value
            })
        });
        
        if (response.ok) {
            alert('–¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ!');
            bootstrap.Modal.getInstance(document.getElementById('testModal')).hide();
        } else {
            const error = await response.json();
            alert(`–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏: ${error.detail}`);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è');
    }
}

async function handleFormSubmit(e) {
    e.preventDefault();
    
    // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ —Ä–µ–¥–∞–∫—Ç–æ—Ä–∞
    document.getElementById('templateContent').value = quill.root.innerHTML;
    
    const formData = new FormData(e.target);
    const url = templateId ? `/api/templates/${templateId}` : '/api/templates/';
    const method = templateId ? 'PUT' : 'POST';
    
    try {
        const response = await fetch(url, {
            method: method,
            body: formData
        });
        
        if (response.ok) {
            const data = await response.json();
            alert(templateId ? '–®–∞–±–ª–æ–Ω –æ–±–Ω–æ–≤–ª–µ–Ω!' : '–®–∞–±–ª–æ–Ω —Å–æ–∑–¥–∞–Ω!');
            
            if (!templateId) {
                window.location.href = `/broadcasts/templates/${data.template_id}/edit`;
            }
        } else {
            const error = await response.json();
            alert(`–û—à–∏–±–∫–∞: ${error.detail}`);
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞');
    }
}

async function deleteTemplate() {
    if (!templateId) return;
    
    if (!confirm('–£–¥–∞–ª–∏—Ç—å —à–∞–±–ª–æ–Ω? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.')) return;
    
    try {
        const response = await fetch(`/api/templates/${templateId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            alert('–®–∞–±–ª–æ–Ω —É–¥–∞–ª–µ–Ω!');
            window.location.href = '/broadcasts/templates';
        } else {
            alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞');
        }
    } catch (error) {
        console.error('–û—à–∏–±–∫–∞:', error);
        alert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —à–∞–±–ª–æ–Ω–∞');
    }
}

// –ì–æ—Ä—è—á–∏–µ –∫–ª–∞–≤–∏—à–∏
document.addEventListener('keydown', function(e) {
    // Ctrl+S - —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å
    if (e.ctrlKey && e.key === 's') {
        e.preventDefault();
        document.getElementById('templateForm').dispatchEvent(new Event('submit'));
    }
    
    // Ctrl+T - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å
    if (e.ctrlKey && e.key === 't') {
        e.preventDefault();
        testTemplate();
    }
});
</script>
{% endblock %}
